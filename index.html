<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Quem limpa a sala hoje?</title>
  <style>
    /* Seu CSS original aqui (mantive só o essencial pra brevidade) */
    body {
      font-family: Arial, sans-serif;
      background: #f0f2f5;
      color: #2c3e50;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
    }
    #app {
      width: 420px;
      background: #fff;
      padding: 30px 40px;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
      text-align: center;
      position: relative;
      border: 1px solid #dcdcdc;
    }
    h1 {
      margin-bottom: 12px;
      font-weight: 700;
    }
    button, input {
      font-size: 16px;
      border-radius: 6px;
      border: none;
      padding: 10px 18px;
      margin: 10px 6px;
      cursor: pointer;
      font-weight: bold;
      transition: background-color 0.3s ease;
      outline: none;
    }
    button {
      background-color: #2c3e50;
      color: white;
    }
    button:hover {
      background-color: #34495e;
    }
    #checkboxContainer div {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 8px;
      justify-content: flex-start;
    }
    #formQuemLimpou button[type="submit"] {
      margin-top: 20px;
      width: 100%;
    }
    #btnContinuar {
      margin-top: 10px;
      background-color: #27ae60;
      width: 100%;
    }
    #btnContinuar:hover {
      background-color: #2ecc71;
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- Telas iniciais e login -->
    <div id="telaInicial">
      <h1>Quem limpa a sala hoje?</h1>
      <p>Escolha seu perfil para continuar:</p>
      <button id="btnProfessor">Professor / Representante</button>
      <button id="btnEstudante">Estudante</button>
    </div>

    <div id="telaLogin" style="display:none;">
      <h1>Login - Professor / Representante</h1>
      <div id="mensagemErro" style="color:red; font-weight:bold;"></div>
      <input type="email" id="emailLogin" placeholder="Email" autocomplete="username" />
      <input type="password" id="senhaLogin" placeholder="Senha" autocomplete="current-password" />
      <div id="botoesLogin">
        <button id="btnEntrar">Entrar</button>
        <button id="btnVoltarLogin">Voltar</button>
      </div>
    </div>

    <!-- Tela principal da escala -->
    <div id="conteudoEscala" style="display:none;">
      <h1>Quem limpa a sala hoje?</h1>
      <div id="resultado">
        <h2>Escala de hoje:</h2>
        <ul id="listaEscala"></ul>
      </div>
      <div id="pergunta" style="display:none;">
        <p>Selecione quem <strong>faltou</strong> e clique em "Confirmar":</p>
        <form id="formQuemLimpou">
          <div id="checkboxContainer"></div>
          <button type="submit">Confirmar</button>
        </form>
      </div>
      <button id="btnContinuar" style="display:none;">Continuar</button>
    </div>
  </div>

  <!-- Firebase (mesmo) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
  // Config Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyAGkdnFfJNw4r6yYpSGIpgjwISBOppwR60",
    authDomain: "quem-limpa-hoje.firebaseapp.com",
    projectId: "quem-limpa-hoje",
    storageBucket: "quem-limpa-hoje.firebasestorage.app",
    messagingSenderId: "44929275404",
    appId: "1:44929275404:web:971258e864925cb3684029"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // Variáveis
  let admins = ["prof1@escola.com", "prof2@escola.com", "nicolasgmbatista15@gmail.com"];
  let nomes = ["Ana", "Beatriz", "Bernardo", "Emanuelly", "Gabriel", "Gabrielle", "Greicy", "Henzo", "Igor", "Isadora", "Jennifer", "Joedna", "Kemilly Silva", "Kemilly Puff", "Luiz", "Mateus Yuri", "Mateus Chagas", "Nayara", "Nicolas", "Norehangeles", "Pedro", "Samuel", "Sebastião", "Zaira"].sort((a,b) => a.localeCompare(b));

  let posicaoUltimaEscala = -1;
  let historicoTarefa = {};
  let escalaAtual = [];
  let faltantesPendentes = [];

  let usuarioLogado = null;
  let isAdmin = false;

  // Funções para telas
  function mostrarTela(t) {
    document.getElementById('telaInicial').style.display = 'none';
    document.getElementById('telaLogin').style.display = 'none';
    document.getElementById('conteudoEscala').style.display = 'none';

    if (t === 'inicio') {
      document.getElementById('telaInicial').style.display = 'block';
    } else if (t === 'login') {
      document.getElementById('telaLogin').style.display = 'block';
    } else if (t === 'painel') {
      document.getElementById('conteudoEscala').style.display = 'block';
    }
  }

  // Inicializa com tela inicial
  mostrarTela('inicio');

  // Leitura e salvamento Firestore
  async function salvarEscalaNoFirestore() {
    await db.collection('escala').doc('dados').set({
      posicaoUltimaEscala,
      historicoTarefa,
      escalaAtual,
      faltantesPendentes
    });
  }

  async function lerEscalaDoFirestore() {
    const doc = await db.collection('escala').doc('dados').get();
    if (doc.exists) {
      const data = doc.data();
      posicaoUltimaEscala = data.posicaoUltimaEscala ?? -1;
      historicoTarefa = data.historicoTarefa ?? {};
      escalaAtual = data.escalaAtual ?? [];
      faltantesPendentes = data.faltantesPendentes ?? [];
    } else {
      posicaoUltimaEscala = -1;
      historicoTarefa = {};
      escalaAtual = [];
      faltantesPendentes = [];
    }
  }

  // Próximo índice ignorando nomes na lista ignorados
  function proximoIndice(atual, ignorados=[]) {
    let i = atual;
    for(let c=0; c<nomes.length; c++) {
      i = (i+1)%nomes.length;
      if(!ignorados.includes(nomes[i])) return i;
    }
    return -1;
  }

  // Alternar tarefa mesa <-> chão
  function alternarTarefa(tarefa) {
    return tarefa === 'mesa' ? 'chão' : 'mesa';
  }

  // Gerar escala nova
  async function gerarEscala() {
    const retornantes = [...faltantesPendentes];
    faltantesPendentes = [];
    let usados = retornantes.map(f=>f.nome);
    let idx = posicaoUltimaEscala;

    if (escalaAtual.length === 0) {
      const idx1 = proximoIndice(idx, usados);
      const n1 = nomes[idx1];
      const t1 = alternarTarefa(historicoTarefa[n1]||'mesa');
      historicoTarefa[n1] = t1;
      usados.push(n1);

      const idx2 = proximoIndice(idx1, usados);
      const n2 = nomes[idx2];
      const t2 = alternarTarefa(t1);
      historicoTarefa[n2] = t2;

      escalaAtual = [{nome:n1,tarefa:t1,index:idx1},{nome:n2,tarefa:t2,index:idx2}];
      posicaoUltimaEscala = idx2;
      await salvarEscalaNoFirestore();
      atualizarResultadoEFormulario();
      return;
    }

    const presentes = escalaAtual.filter(p=>!retornantes.some(f=>f.nome === p.nome));
    const substitutos = [];
    usados = escalaAtual.map(p=>p.nome).concat(retornantes.map(f=>f.nome));
    for(let i=0; i<presentes.length; i++){
      idx = proximoIndice(idx, usados);
      const n = nomes[idx];
      const t = i === 0 ? alternarTarefa(historicoTarefa[n]||'mesa') : substitutos[0].tarefa==='mesa'?'chão':'mesa';
      historicoTarefa[n] = t;
      substitutos.push({nome:n,tarefa:t,index:idx});
      usados.push(n);
    }
    escalaAtual = [...retornantes, ...substitutos];
    posicaoUltimaEscala = substitutos[substitutos.length-1].index;
    await salvarEscalaNoFirestore();
    atualizarResultadoEFormulario();
  }

  // Atualiza interface escala e formulário faltantes
  function atualizarResultadoEFormulario() {
    const ulEscala = document.getElementById('listaEscala');
    ulEscala.innerHTML = '';
    escalaAtual.forEach(p => {
      const li = document.createElement('li');
      li.textContent = `${p.nome} - ${p.tarefa}`;
      ulEscala.appendChild(li);
    });

    const container = document.getElementById('checkboxContainer');
    container.innerHTML = '';

    escalaAtual.forEach(p => {
      const div = document.createElement('div');
      const input = document.createElement('input');
      input.type = 'checkbox';
      input.id = 'cb_' + p.nome.replace(/\s/g, '');
      input.value = p.nome;
      div.appendChild(input);

      const label = document.createElement('label');
      label.htmlFor = input.id;
      label.textContent = p.nome;
      div.appendChild(label);

      container.appendChild(div);
    });

    // Mostrar sempre formulário para marcar faltantes
    document.getElementById('pergunta').style.display = 'block';

    // Mostrar botão continuar só para admins
    document.getElementById('btnContinuar').style.display = isAdmin ? 'inline-block' : 'none';
  }

  // Eventos botões
  document.getElementById('btnProfessor').onclick = () => mostrarTela('login');
  document.getElementById('btnEstudante').onclick = async () => {
    usuarioLogado = null;
    isAdmin = false;
    mostrarTela('painel');
    await carregarEscala();
  };
  document.getElementById('btnVoltarLogin').onclick = () => mostrarTela('inicio');

  // Login simples fake
  document.getElementById('btnEntrar').onclick = async () => {
    const email = document.getElementById('emailLogin').value.trim();
    const senha = document.getElementById('senhaLogin').value.trim();
    const erroEl = document.getElementById('mensagemErro');
    erroEl.textContent = '';

    if(!email || !senha) {
      erroEl.textContent = 'Preencha email e senha.';
      return;
    }

    if(admins.includes(email)) {
      usuarioLogado = email;
      isAdmin = true;
      mostrarTela('painel');
      await carregarEscala();
    } else {
      erroEl.textContent = 'Usuário não autorizado.';
    }
  };

  // Botão continuar - só admins usam para avançar escala
  document.getElementById('btnContinuar').onclick = async () => {
    await gerarEscala();
  };

  // Form confirmar faltantes
  document.getElementById('formQuemLimpou').onsubmit = async (e) => {
    e.preventDefault();
    const checkboxes = document.querySelectorAll('#checkboxContainer input[type=checkbox]');
    const faltaram = [];
    checkboxes.forEach(cb => {
      if(cb.checked) faltaram.push(cb.value);
    });

    faltantesPendentes = faltaram.map(nome => {
      const pessoa = escalaAtual.find(p => p.nome === nome);
      return pessoa ? {nome: pessoa.nome, tarefa: pessoa.tarefa, index: pessoa.index} : null;
    }).filter(Boolean);

    await salvarEscalaNoFirestore();

    alert('Faltantes confirmados!');

    await carregarEscala();
  };

  // Carrega escala
  async function carregarEscala() {
    await lerEscalaDoFirestore();

    if(escalaAtual.length === 0) {
      await gerarEscala();
    } else {
      atualizarResultadoEFormulario();
    }
  }
  </script>
</body>
</html>
