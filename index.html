<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Quem limpa a sala hoje?</title>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #f0f2f5;
      color: #2c3e50;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
    }

    #app {
      width: 420px;
      background: #fff;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
      text-align: center;
      position: relative;
      border: 1px solid #e0e0e0;
      margin-bottom: 60px;
    }

    h1 {
      margin-bottom: 20px;
      font-weight: 600;
      font-size: 24px;
      color: #2c3e50;
    }

    h2 {
      font-size: 20px;
      margin-bottom: 16px;
      color: #2c3e50;
    }

    button, input {
      font-size: 16px;
      border-radius: 8px;
      border: none;
      padding: 12px;
      margin: 8px 0;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s ease;
      outline: none;
    }

    button {
      background-color: #2c3e50;
      color: white;
    }

    button:hover {
      background-color: #34495e;
    }

    input[type="email"], input[type="password"], input[type="text"], input[type="number"] {
      width: 100%;
      max-width: 300px;
      border: 2px solid #dcdcdc;
      transition: border-color 0.3s ease;
      padding: 12px;
      box-sizing: border-box;
    }

    input[type="email"]:focus, input[type="password"]:focus, input[type="text"]:focus, input[type="number"]:focus {
      border-color: #2c3e50;
    }

    #menuBtn {
      position: absolute;
      top: 20px;
      right: 20px;
      background: transparent;
      font-size: 28px;
      color: #2c3e50;
      border: none;
      cursor: pointer;
      padding: 0;
    }

    #menuLateral {
      position: fixed;
      top: 0;
      right: -300px;
      width: 300px;
      height: 100vh;
      background: #2c3e50;
      color: white;
      padding: 20px;
      display: none;
      flex-direction: column;
      gap: 15px;
      box-shadow: -5px 0 10px rgba(0,0,0,0.2);
      z-index: 1000;
      transition: right 0.3s ease;
    }

    #menuLateral.aberto {
      right: 0;
      display: flex;
    }

    #menuLateral button,
    #fecharMenu {
      background: #34495e;
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      font-size: 16px;
    }

    #menuLateral button:hover,
    #fecharMenu:hover {
      background: #3c5a7a;
    }

    #resultado h2 {
      margin-bottom: 12px;
      font-weight: 600;
    }

    #resultado ul {
      list-style: none;
      padding: 0;
      margin: 0 0 20px 0;
      text-align: left;
    }

    #resultado li {
      background: #f5f7fa;
      margin-bottom: 8px;
      padding: 12px;
      border-radius: 8px;
      color: #2c3e50;
      font-weight: 500;
      display: flex;
      justify-content: space-between;
    }

    #botoesLaboratorios {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 20px;
      flex-wrap: wrap;
    }

    #botoesLaboratorios button {
      width: 32%;
      max-width: 120px;
    }

    #checkboxContainer {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: center;
      margin-top: 12px;
    }

    #checkboxContainer div {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    #formQuemLimpou {
      margin-top: 20px;
      max-width: 300px;
      margin-left: auto;
      margin-right: auto;
    }

    #formQuemLimpou button[type="submit"] {
      margin-top: 20px;
      width: 100%;
      max-width: 300px;
    }

    #btnReset {
      background-color: #c0392b;
    }

    #btnReset:hover {
      background-color: #e74c3c;
    }

    #mensagemErro, #mensagemErroMinhaConta, #mensagemErroLaboratorio {
      color: #c0392b;
      font-weight: 500;
      margin-bottom: 12px;
      font-size: 14px;
    }

    #mensagemAviso {
      color: #e67e22;
      font-weight: 500;
      margin-bottom: 12px;
      font-size: 14px;
    }

    #btnContinuar {
      margin-top: 12px;
      background-color: #27ae60;
      width: 100%;
      max-width: 300px;
      margin-left: auto;
      margin-right: auto;
    }

    #btnContinuar:hover {
      background-color: #2ecc71;
    }

    #telaInicial button, #telaSelecaoTurma button {
      width: 100%;
      max-width: 200px;
    }

    #checkboxContainer div label {
      font-size: 16px;
    }

    #avisoReset {
      margin-top: 20px;
      color: #e74c3c;
      font-weight: 500;
      font-size: 14px;
      text-align: center;
    }

    #telaLogin {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }

    #telaLogin input {
      width: 100%;
      max-width: 300px;
    }

    #botoesLogin {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      width: 100%;
      max-width: 300px;
    }

    #botoesLogin button {
      width: 48%;
      min-width: 120px;
    }

    #btnEsqueciSenha {
      background: transparent;
      color: #2c3e50;
      text-decoration: underline;
      font-size: 14px;
      padding: 5px;
      margin-top: 5px;
      width: auto;
    }

    #btnEsqueciSenha:hover {
      color: #34495e;
    }

    #telaEditarNomes, #telaGerenciarAdmins, #telaMinhaConta, #telaLaboratorios, #telaGerenciarLaboratorio {
      display: none;
      flex-direction: column;
      align-items: center;
      max-width: 360px;
      margin: 0 auto;
    }

    #listaNomesEdicao, #listaAdminsEdicao, #listaGruposLaboratorio {
      list-style: none;
      padding: 0;
      width: 100%;
      max-height: 300px;
      overflow-y: auto;
      margin-bottom: 16px;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      background: #f9fafb;
    }

    #listaNomesEdicao li, #listaAdminsEdicao li, #listaGruposLaboratorio li {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      border-bottom: 1px solid #e0e0e0;
      font-weight: 500;
      color: #2c3e50;
      word-break: break-word;
    }

    #listaNomesEdicao li:last-child, #listaAdminsEdicao li:last-child, #listaGruposLaboratorio li:last-child {
      border-bottom: none;
    }

    #listaAdminsEdicao button.removerAdminBtn, #listaGruposLaboratorio button.removerGrupoBtn, #listaGruposLaboratorio button.editarGrupoBtn {
      background-color: #c0392b;
      padding: 6px 10px;
      font-size: 13px;
      border-radius: 6px;
      min-width: 60px;
      width: 60px;
      text-align: center;
      line-height: 1.2;
    }

    #listaNomesEdicao button.removerNomeBtn {
      background-color: #c0392b;
      padding: 6px 10px;
      font-size: 13px;
      border-radius: 6px;
      min-width: 80px;
      width: 80px;
      text-align: center;
      line-height: 1.2;
      white-space: nowrap;
    }

    #listaNomesEdicao button.removerNomeBtn:hover, #listaAdminsEdicao button.removerAdminBtn:hover, #listaGruposLaboratorio button.removerGrupoBtn:hover, #listaGruposLaboratorio button.editarGrupoBtn:hover {
      background-color: #e74c3c;
    }

    #listaGruposLaboratorio button.editarGrupoBtn {
      background-color: #2980b9;
    }

    #listaGruposLaboratorio button.editarGrupoBtn:hover {
      background-color: #3498db;
    }

    #listaAdminsEdicao span.criador {
      background-color: #f1c40f;
      color: #fff;
      font-weight: 600;
      font-size: 13px;
      padding: 6px 10px;
      border-radius: 6px;
      min-width: 60px;
      width: 60px;
      text-align: center;
      line-height: 1.2;
    }

    #novoNomeContainer, #novoAdminContainer, #alterarSenhaContainer, #novoGrupoContainer {
      display: flex;
      flex-direction: column;
      gap: 10px;
      width: 100%;
      max-width: 300px;
      margin-bottom: 16px;
    }

    #novoNomeInput, #novoAdminInput, #novaSenhaAdminInput, #novaSenhaInput, #confirmarSenhaInput, #nomeGrupoInput, #funcaoGrupoInput {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      border-radius: 8px;
      border: 2px solid #dcdcdc;
    }

    #novoNomeContainer button, #novoAdminContainer button, #novoGrupoContainer button {
      width: 100%;
      max-width: 300px;
    }

    #telaEditarNomes button, #telaGerenciarAdmins button, #telaMinhaConta button, #telaLaboratorios button, #telaGerenciarLaboratorio button {
      width: 100%;
      max-width: 300px;
    }

    footer {
      position: fixed;
      bottom: 0;
      width: 100%;
      background: #2c3e50;
      color: #fff;
      text-align: center;
      padding: 10px 0;
      font-size: 14px;
      font-weight: 400;
      border-top: 1px solid #34495e;
      z-index: 1000;
    }

    footer a {
      color: #fff;
      text-decoration: none;
      font-weight: 500;
    }

    footer a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- Tela de seleção de turma -->
    <div id="telaSelecaoTurma">
      <h1>Quem limpa a sala hoje?</h1>
      <p>Escolha a turma:</p>
      <button id="btnMatutino">Matutino</button>
      <button id="btnVespertino">Vespertino</button>
    </div>

    <!-- Telas iniciais e login -->
    <div id="telaInicial" style="display:none;">
      <h1>Quem limpa a sala hoje?</h1>
      <p>Escolha seu perfil para continuar:</p>
      <button id="btnProfessor">Administrador</button>
      <button id="btnEstudante">Estudante</button>
    </div>

    <div id="telaLogin" style="display:none;">
      <h1>Login - Administrador</h1>
      <div id="mensagemErro"></div>
      <input type="email" id="emailLogin" placeholder="Email" autocomplete="username" />
      <input type="password" id="senhaLogin" placeholder="Senha" autocomplete="current-password" />
      <div id="botoesLogin">
        <button id="btnEntrar">Entrar</button>
        <button id="btnVoltarLogin">Voltar</button>
      </div>
      <button id="btnEsqueciSenha">Esqueci minha senha</button>
    </div>

    <!-- Tela principal da escala -->
    <div id="conteudoEscala" style="display:none;">
      <button id="menuBtn" title="Abrir menu" style="display:none;">☰</button>
      <h1>Quem limpa a sala hoje?</h1>
      <div id="resultado">
        <h2>Escala de hoje:</h2>
        <ul id="listaEscala"></ul>
        <button id="btnContinuar" style="display:none;">Continuar</button>
        <div id="botoesLaboratorios" style="display:none;">
          <button id="btnLab303Estudante">LAB 303</button>
          <button id="btnLab304Estudante">LAB 304</button>
          <button id="btnVoltarEstudante">Voltar</button>
        </div>
      </div>
      <div id="pergunta" style="display:none;">
        <p>Selecione quem <strong>faltou</strong> ou <strong>limpou o laboratório</strong> e clique em "CONFIRMAR" para atualizar:</p>
        <form id="formQuemLimpou">
          <div id="checkboxContainer"></div>
          <button type="submit">Confirmar</button>
        </form>
      </div>
    </div>

    <!-- Menu lateral -->
    <nav id="menuLateral">
      <button id="fecharMenu" title="Voltar">Voltar</button>
      <button id="btnMinhaConta" style="display:none;">Minha Conta</button>
      <button id="btnGerenciarLaboratorios" style="display:none;">Gerenciar Laboratórios</button>
      <button id="btnEditarNomes" style="display:none;">Editar Nomes</button>
      <button id="btnLiberarAcesso" style="display:none;">Liberar Acesso</button>
      <button id="btnResetar" style="display:none;">Resetar Escala</button>
      <button id="btnSair" style="display:none;">Sair</button>
    </nav>

    <!-- Tela para edição dos nomes -->
    <div id="telaEditarNomes">
      <h2>Editar Nomes</h2>
      <ul id="listaNomesEdicao"></ul>
      <div id="novoNomeContainer">
        <input type="text" id="novoNomeInput" placeholder="Digite novo nome" />
        <button id="btnAdicionarNome">Adicionar</button>
      </div>
      <button id="btnZerarNomes">Zerar</button>
      <button id="btnVoltarEdicao">Voltar</button>
    </div>

    <!-- Tela para gerenciar administradores -->
    <div id="telaGerenciarAdmins">
      <h2>Gerenciar Administradores</h2>
      <ul id="listaAdminsEdicao"></ul>
      <div id="novoAdminContainer">
        <input type="email" id="novoAdminInput" placeholder="Digite novo email" />
        <input type="password" id="novaSenhaAdminInput" placeholder="Senha inicial" />
        <button id="btnAdicionarAdmin">Adicionar</button>
      </div>
      <button id="btnVoltarAdmins">Voltar</button>
    </div>

    <!-- Tela para minha conta -->
    <div id="telaMinhaConta">
      <h2>Minha Conta</h2>
      <div id="mensagemAviso"></div>
      <div id="mensagemErroMinhaConta"></div>
      <div id="alterarSenhaContainer">
        <input type="password" id="novaSenhaInput" placeholder="Nova senha" />
        <input type="password" id="confirmarSenhaInput" placeholder="Confirmar nova senha" />
        <button id="btnAlterarSenha">Alterar Senha</button>
      </div>
      <button id="btnVoltarMinhaConta">Voltar</button>
    </div>

    <!-- Tela de seleção de laboratório -->
    <div id="telaLaboratorios">
      <h2>Escolha o Laboratório</h2>
      <button id="btnLab303">LAB 303</button>
      <button id="btnLab304">LAB 304</button>
      <button id="btnVoltarLaboratorios">Voltar</button>
    </div>

    <!-- Tela para gerenciar laboratório -->
    <div id="telaGerenciarLaboratorio">
      <h2 id="tituloLaboratorio">Gerenciar Laboratório</h2>
      <div id="mensagemErroLaboratorio"></div>
      <ul id="listaGruposLaboratorio"></ul>
      <div id="novoGrupoContainer" style="display:none;">
        <input type="text" id="nomeGrupoInput" placeholder="Nome do grupo (ex.: Grupo 1)" />
        <input type="text" id="funcaoGrupoInput" placeholder="Função do grupo" />
        <button id="btnAdicionarGrupo">Adicionar Grupo</button>
      </div>
      <button id="btnAvancarRodizio" style="display:none;">Avançar Rodízio</button>
      <button id="btnVoltarGerenciarLaboratorio">Voltar</button>
    </div>
  </div>

  <footer>
    © 2025 Nicolas GBM — Criador | Contato: <a href="mailto:nicolasgmbatista15@gmail.com">nicolasgmbatista15@gmail.com</a>
  </footer>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  
  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyAGkdnFfJNw4r6yYpSGIpgjwISBOppwR60",
      authDomain: "quem-limpa-hoje.firebaseapp.com",
      projectId: "quem-limpa-hoje",
      storageBucket: "quem-limpa-hoje.firebasestorage.app",
      messagingSenderId: "44929275404",
      appId: "1:44929275404:web:971258e864925cb3684029"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // Variáveis globais
    let turmaAtual = null; // 'matutino' ou 'vespertino'
    const ADMIN_PERMANENTE = "nicolasgmbatista15@gmail.com";
    let usuarioLogado = null;
    let isAdmin = false;
    let telaAtual = 'selecao-turma';
    let adminConfig = {};
    let laboratorioAtual = null; // 'lab303' ou 'lab304'

    // Dados por turma
    let dadosTurmas = {
      matutino: {
        admins: [
          "gonzagamezzomozaira@gmail.com",
          "fabiana.martini@edu.sc.senai.br",
          "beatriz_k_morais@estudante.sesisenai.org.br",
          "nicolasgmbatista15@gmail.com",
          "cassia.savi@edu.sc.senai.br"
        ],
        nomes: ["Ana", "Beatriz", "Bernardo", "Emanuelly", "Gabriel", "Gabrielle", "Greicy", "Henzo", "Igor", "Isadora", "Jennifer", "Joedna", "Kemilly Silva", "Kemilly Puff", "Luiz", "Mateus Yuri", "Mateus Chagas", "Nayara", "Nicolas", "Norehangeles", "Pedro", "Samuel", "Sebastião", "Zaira"].sort((a, b) => a.localeCompare(b)),
        posicaoUltimaEscala: -1,
        historicoTarefa: {},
        escalaAtual: [],
        faltantesPendentes: [],
        lab303: { grupos: [], posicaoUltimaFuncao: -1 },
        lab304: { grupos: [], posicaoUltimaFuncao: -1 }
      },
      vespertino: {
        admins: ["nicolasgmbatista15@gmail.com"],
        nomes: [],
        posicaoUltimaEscala: -1,
        historicoTarefa: {},
        escalaAtual: [],
        faltantesPendentes: [],
        lab303: { grupos: [], posicaoUltimaFuncao: -1 },
        lab304: { grupos: [], posicaoUltimaFuncao: -1 }
      }
    };

    // Funções para mostrar/ocultar telas
    function mostrarTela(t) {
      telaAtual = t;
      document.getElementById('telaSelecaoTurma').style.display = 'none';
      document.getElementById('telaInicial').style.display = 'none';
      document.getElementById('telaLogin').style.display = 'none';
      document.getElementById('conteudoEscala').style.display = 'none';
      document.getElementById('telaEditarNomes').style.display = 'none';
      document.getElementById('telaGerenciarAdmins').style.display = 'none';
      document.getElementById('telaMinhaConta').style.display = 'none';
      document.getElementById('telaLaboratorios').style.display = 'none';
      document.getElementById('telaGerenciarLaboratorio').style.display = 'none';
      document.getElementById('menuBtn').style.display = 'none';
      document.getElementById('menuLateral').classList.remove('aberto');
      document.getElementById('menuLateral').style.display = 'none';
      document.getElementById('btnContinuar').style.display = 'none';
      document.getElementById('botoesLaboratorios').style.display = 'none';
      document.getElementById('pergunta').style.display = 'none';
      document.getElementById('novoGrupoContainer').style.display = 'none';
      document.getElementById('btnAvancarRodizio').style.display = 'none';
      document.getElementById('btnMinhaConta').style.display = 'none';
      document.getElementById('btnEditarNomes').style.display = 'none';
      document.getElementById('btnLiberarAcesso').style.display = 'none';
      document.getElementById('btnResetar').style.display = 'none';
      document.getElementById('btnGerenciarLaboratorios').style.display = 'none';
      document.getElementById('btnSair').style.display = 'none';

      switch (t) {
        case 'selecao-turma':
          document.getElementById('telaSelecaoTurma').style.display = 'block';
          break;
        case 'inicio':
          document.getElementById('telaInicial').style.display = 'block';
          break;
        case 'login':
          document.getElementById('telaLogin').style.display = 'flex';
          document.getElementById('emailLogin').value = '';
          document.getElementById('senhaLogin').value = '';
          document.getElementById('mensagemErro').textContent = '';
          break;
        case 'painel':
          document.getElementById('conteudoEscala').style.display = 'block';
          document.getElementById('menuBtn').style.display = isAdmin ? 'block' : 'none';
          document.getElementById('menuLateral').style.display = isAdmin ? 'none' : 'none';
          document.getElementById('btnContinuar').style.display = isAdmin ? 'block' : 'none';
          document.getElementById('botoesLaboratorios').style.display = isAdmin ? 'none' : 'flex';
          document.getElementById('pergunta').style.display = isAdmin ? 'block' : 'none';
          document.getElementById('btnMinhaConta').style.display = isAdmin ? 'block' : 'none';
          document.getElementById('btnGerenciarLaboratorios').style.display = isAdmin ? 'block' : 'none';
          document.getElementById('btnEditarNomes').style.display = isAdmin ? 'block' : 'none';
          document.getElementById('btnLiberarAcesso').style.display = isAdmin ? 'block' : 'none';
          document.getElementById('btnResetar').style.display = isAdmin ? 'block' : 'none';
          document.getElementById('btnSair').style.display = isAdmin ? 'block' : 'none';
          atualizarResultadoEFormulario();
          if (isAdmin) montarCheckboxFaltantes();
          break;
        case 'editar-nomes':
          document.getElementById('telaEditarNomes').style.display = 'flex';
          atualizarListaNomesEdicao();
          break;
        case 'gerenciar-admins':
          document.getElementById('telaGerenciarAdmins').style.display = 'flex';
          atualizarListaAdminsEdicao();
          break;
        case 'minha-conta':
          document.getElementById('telaMinhaConta').style.display = 'flex';
          atualizarTelaMinhaConta();
          break;
        case 'laboratorios':
          document.getElementById('telaLaboratorios').style.display = 'flex';
          break;
        case 'gerenciar-laboratorio':
          document.getElementById('telaGerenciarLaboratorio').style.display = 'flex';
          document.getElementById('novoGrupoContainer').style.display = isAdmin ? 'block' : 'none';
          document.getElementById('btnAvancarRodizio').style.display = isAdmin ? 'block' : 'none';
          atualizarListaGruposLaboratorio();
          document.getElementById('tituloLaboratorio').textContent = `${isAdmin ? 'Gerenciar' : 'Escala'} ${laboratorioAtual.toUpperCase()}`;
          break;
      }
      console.log(`Tela atual: ${telaAtual}, Turma: ${turmaAtual}, Laboratório: ${laboratorioAtual}`);
    }

    // Inicializa app
    mostrarTela('selecao-turma');

    // Funções de persistência
    async function salvarEscalaNoFirestore() {
      if (!turmaAtual) return;
      try {
        const turmaData = dadosTurmas[turmaAtual];
        await db.collection('escala').doc(turmaAtual).collection('sala').doc('dados').set({
          posicaoUltimaEscala: turmaData.posicaoUltimaEscala,
          historicoTarefa: turmaData.historicoTarefa,
          escalaAtual: turmaData.escalaAtual,
          faltantesPendentes: turmaData.faltantesPendentes
        });
        console.log(`Escala salva no Firestore para ${turmaAtual}:`, turmaData);
      } catch (error) {
        console.error("Erro ao salvar no Firestore:", error);
        alert("Erro ao salvar a escala. Verifique sua conexão.");
      }
    }

    async function salvarConfigNoFirestore() {
      if (!turmaAtual) return;
      try {
        const turmaData = dadosTurmas[turmaAtual];
        await db.collection('escala').doc(turmaAtual).collection('config').doc('dados').set({
          nomes: turmaData.nomes,
          admins: turmaData.admins,
          adminConfig
        }, { merge: true });
        console.log(`Config salva no Firestore para ${turmaAtual}:`, { nomes: turmaData.nomes, admins: turmaData.admins, adminConfig });
      } catch (error) {
        console.error('Erro ao salvar config no Firestore:', error);
        alert('Erro ao salvar configurações. Verifique sua conexão.');
      }
    }

    async function salvarLaboratorioNoFirestore(lab) {
      if (!turmaAtual || !lab) return;
      try {
        const labData = dadosTurmas[turmaAtual][lab];
        await db.collection('escala').doc(turmaAtual).collection(lab).doc('dados').set({
          grupos: labData.grupos,
          posicaoUltimaFuncao: labData.posicaoUltimaFuncao
        });
        console.log(`Laboratório ${lab} salvo no Firestore para ${turmaAtual}:`, labData);
      } catch (error) {
        console.error(`Erro ao salvar ${lab} no Firestore:`, error);
        alert(`Erro ao salvar dados do laboratório ${lab.toUpperCase()}. Verifique sua conexão.`);
      }
    }

    async function lerDadosDoFirestore() {
      if (!turmaAtual) {
        console.error("Erro: turmaAtual não definida ao tentar ler dados do Firestore");
        return;
      }

      const timeoutPromise = new Promise((_, reject) => {
        setTimeout(() => reject(new Error('Timeout ao carregar dados do Firestore')), 5000);
      });

      try {
        console.log(`Iniciando leitura do Firestore para turma: ${turmaAtual}`);
        const salaDocPromise = db.collection('escala').doc(turmaAtual).collection('sala').doc('dados').get();
        const configDocPromise = db.collection('escala').doc(turmaAtual).collection('config').doc('dados').get();
        const lab303DocPromise = db.collection('escala').doc(turmaAtual).collection('lab303').doc('dados').get();
        const lab304DocPromise = db.collection('escala').doc(turmaAtual).collection('lab304').doc('dados').get();

        const [salaDoc, configDoc, lab303Doc, lab304Doc] = await Promise.race([
          Promise.all([salaDocPromise, configDocPromise, lab303DocPromise, lab304DocPromise]),
          timeoutPromise
        ]);

        const turmaData = dadosTurmas[turmaAtual];

        if (salaDoc.exists) {
          const data = salaDoc.data();
          turmaData.posicaoUltimaEscala = data.posicaoUltimaEscala ?? -1;
          turmaData.historicoTarefa = data.historicoTarefa ?? {};
          turmaData.escalaAtual = data.escalaAtual ?? [];
          turmaData.faltantesPendentes = data.faltantesPendentes ?? [];
          console.log(`Escala carregada do Firestore para ${turmaAtual}:`, turmaData);
        } else {
          console.log(`Nenhum dado de sala encontrado no Firestore para ${turmaAtual}, inicializando vazio`);
          turmaData.escalaAtual = [];
          turmaData.posicaoUltimaEscala = -1;
          turmaData.historicoTarefa = {};
          turmaData.faltantesPendentes = [];
          await salvarEscalaNoFirestore();
        }

        if (configDoc.exists) {
          const configData = configDoc.data();
          turmaData.nomes = configData.nomes ?? (turmaAtual === 'matutino' ? ["Ana", "Beatriz", "Bernardo", "Emanuelly", "Gabriel", "Gabrielle", "Greicy", "Henzo", "Igor", "Isadora", "Jennifer", "Joedna", "Kemilly Silva", "Kemilly Puff", "Luiz", "Mateus Yuri", "Mateus Chagas", "Nayara", "Nicolas", "Norehangeles", "Pedro", "Samuel", "Sebastião", "Zaira"].sort((a, b) => a.localeCompare(b)) : []);
          turmaData.admins = configData.admins ?? [ADMIN_PERMANENTE];
          adminConfig = configData.adminConfig ?? {};
          console.log(`Config carregada do Firestore para ${turmaAtual}:`, { nomes: turmaData.nomes, admins: turmaData.admins, adminConfig });
        } else {
          console.log(`Nenhuma config encontrada no Firestore para ${turmaAtual}, usando padrão`);
          if (turmaAtual === 'vespertino') {
            turmaData.nomes = [];
            turmaData.admins = [ADMIN_PERMANENTE];
          }
          await salvarConfigNoFirestore();
        }

        if (lab303Doc.exists) {
          const labData = lab303Doc.data();
          turmaData.lab303.grupos = labData.grupos ?? [];
          turmaData.lab303.posicaoUltimaFuncao = labData.posicaoUltimaFuncao ?? -1;
          console.log(`LAB 303 carregado para ${turmaAtual}:`, turmaData.lab303);
        } else {
          turmaData.lab303 = { grupos: [], posicaoUltimaFuncao: -1 };
          await salvarLaboratorioNoFirestore('lab303');
        }

        if (lab304Doc.exists) {
          const labData = lab304Doc.data();
          turmaData.lab304.grupos = labData.grupos ?? [];
          turmaData.lab304.posicaoUltimaFuncao = labData.posicaoUltimaFuncao ?? -1;
          console.log(`LAB 304 carregado para ${turmaAtual}:`, turmaData.lab304);
        } else {
          turmaData.lab304 = { grupos: [], posicaoUltimaFuncao: -1 };
          await salvarLaboratorioNoFirestore('lab304');
        }

        atualizarResultadoEFormulario();
      } catch (error) {
        console.error(`Erro ao carregar dados do Firestore para ${turmaAtual}:`, error);
        alert(`Erro ao carregar dados para ${turmaAtual}. Usando valores padrão.`);
        const turmaData = dadosTurmas[turmaAtual];
        if (!turmaData.escalaAtual) turmaData.escalaAtual = [];
        if (!turmaData.posicaoUltimaEscala) turmaData.posicaoUltimaEscala = -1;
        if (!turmaData.historicoTarefa) turmaData.historicoTarefa = {};
        if (!turmaData.faltantesPendentes) turmaData.faltantesPendentes = [];
        if (!turmaData.nomes) {
          turmaData.nomes = turmaAtual === 'matutino' ? ["Ana", "Beatriz", "Bernardo", "Emanuelly", "Gabriel", "Gabrielle", "Greicy", "Henzo", "Igor", "Isadora", "Jennifer", "Joedna", "Kemilly Silva", "Kemilly Puff", "Luiz", "Mateus Yuri", "Mateus Chagas", "Nayara", "Nicolas", "Norehangeles", "Pedro", "Samuel", "Sebastião", "Zaira"].sort((a, b) => a.localeCompare(b)) : [];
        }
        if (!turmaData.admins) turmaData.admins = [ADMIN_PERMANENTE];
        if (!turmaData.lab303) turmaData.lab303 = { grupos: [], posicaoUltimaFuncao: -1 };
        if (!turmaData.lab304) turmaData.lab304 = { grupos: [], posicaoUltimaFuncao: -1 };
        atualizarResultadoEFormulario();
      }
    }

    // Funções da escala de sala
    function proximoIndice(atual, ignorados = []) {
      const nomes = dadosTurmas[turmaAtual].nomes;
      if (!nomes.length) return -1;
      let i = atual;
      if (i < 0 || i >= nomes.length) i = -1;
      for (let c = 0; c < nomes.length; c++) {
        i = (i + 1) % nomes.length;
        if (!ignorados.includes(nomes[i])) {
          console.log(`Próximo índice encontrado: ${i} (${nomes[i]})`);
          return i;
        }
      }
      console.log('Nenhum índice disponível para substituição');
      return -1;
    }

    async function gerarEscala() {
      if (!turmaAtual) return;
      const turmaData = dadosTurmas[turmaAtual];
      if (turmaData.nomes.length === 0) {
        turmaData.escalaAtual = [];
        document.getElementById('listaEscala').innerHTML = '<li>Nenhum nome cadastrado.</li>';
        document.getElementById('pergunta').style.display = isAdmin ? 'block' : 'none';
        document.getElementById('btnContinuar').style.display = isAdmin ? 'block' : 'none';
        document.getElementById('botoesLaboratorios').style.display = isAdmin ? 'none' : 'flex';
        await salvarEscalaNoFirestore();
        console.log('Nenhum nome cadastrado, escala vazia');
        return;
      }

      console.log(`Gerando nova escala para ${turmaAtual}, faltantes pendentes:`, turmaData.faltantesPendentes);
      turmaData.escalaAtual = [...turmaData.faltantesPendentes];
      let usados = turmaData.escalaAtual.map(p => p.nome);
      let idx = turmaData.posicaoUltimaEscala;

      while (turmaData.escalaAtual.length < 2 && turmaData.nomes.length > usados.length) {
        idx = proximoIndice(idx, usados);
        if (idx === -1) break;
        const nome = turmaData.nomes[idx];
        const ultimaTarefa = turmaData.historicoTarefa[nome];
        let tarefa = turmaData.escalaAtual.length === 0 
          ? (ultimaTarefa === 'chão' ? 'mesa' : 'chão')
          : (turmaData.escalaAtual[0].tarefa === 'mesa' ? 'chão' : 'mesa');
        turmaData.escalaAtual.push({ nome, tarefa, index: idx });
        turmaData.historicoTarefa[nome] = tarefa;
        usados.push(nome);
        turmaData.posicaoUltimaEscala = idx;
        console.log(`Adicionado à escala: ${nome} - ${tarefa}`);
      }

      turmaData.faltantesPendentes = [];
      await salvarEscalaNoFirestore();
      atualizarResultadoEFormulario();
    }

    function substituirPessoaNaEscala(nomeRemovido, tarefa) {
      if (!turmaAtual) return;
      const turmaData = dadosTurmas[turmaAtual];
      if (turmaData.nomes.length === 0) {
        turmaData.escalaAtual = [];
        turmaData.faltantesPendentes = turmaData.faltantesPendentes.filter(f => f.nome !== nomeRemovido);
        console.log('Nenhum nome disponível, escala zerada');
        return;
      }

      const pessoaRemovida = turmaData.escalaAtual.find(p => p.nome === nomeRemovido);
      const indiceRemovido = pessoaRemovida ? pessoaRemovida.index : turmaData.nomes.indexOf(nomeRemovido);

      // Remover a pessoa da escala atual
      turmaData.escalaAtual = turmaData.escalaAtual.filter(p => p.nome !== nomeRemovido);

      // Se a escala ainda tiver menos de 2 pessoas, encontrar um substituto
      if (turmaData.escalaAtual.length < 2) {
        let usados = turmaData.escalaAtual.map(p => p.nome).concat(turmaData.faltantesPendentes.map(f => f.nome));
        let idx = indiceRemovido;

        // Garantir que o próximo índice seja exatamente o seguinte na lista ordenada
        idx = proximoIndice(idx, usados);
        if (idx !== -1) {
          const novoNome = turmaData.nomes[idx];
          turmaData.escalaAtual.push({ nome: novoNome, tarefa, index: idx });
          turmaData.historicoTarefa[novoNome] = tarefa;
          turmaData.posicaoUltimaEscala = idx;
          console.log(`Substituído ${nomeRemovido} por ${novoNome} - ${tarefa}`);
        } else {
          console.log(`Nenhum substituto disponível para ${nomeRemovido}`);
        }
      }

      // Reordenar a escala para manter a ordem alfabética
      turmaData.escalaAtual.sort((a, b) => a.index - b.index);
      console.log(`Escala após substituição:`, turmaData.escalaAtual);
    }

    function atualizarResultadoEFormulario() {
      if (!turmaAtual) return;
      const turmaData = dadosTurmas[turmaAtual];
      const listaEscala = document.getElementById('listaEscala');
      listaEscala.innerHTML = '';
      if (turmaData.escalaAtual.length === 0) {
        listaEscala.innerHTML = '<li>Nenhuma escala disponível.</li>';
        document.getElementById('pergunta').style.display = isAdmin ? 'block' : 'none';
        document.getElementById('btnContinuar').style.display = isAdmin ? 'block' : 'none';
        document.getElementById('botoesLaboratorios').style.display = isAdmin ? 'none' : 'flex';
      } else {
        turmaData.escalaAtual.forEach(p => {
          const li = document.createElement('li');
          li.textContent = `${p.nome} - ${p.tarefa}`;
          listaEscala.appendChild(li);
        });
        document.getElementById('pergunta').style.display = isAdmin ? 'block' : 'none';
        document.getElementById('btnContinuar').style.display = isAdmin ? 'block' : 'none';
        document.getElementById('botoesLaboratorios').style.display = isAdmin ? 'none' : 'flex';
        if (isAdmin) montarCheckboxFaltantes();
      }
      console.log(`Interface atualizada para ${turmaAtual}, escala atual:`, turmaData.escalaAtual, 'Faltantes pendentes:', turmaData.faltantesPendentes);
    }

    function montarCheckboxFaltantes() {
      if (!turmaAtual) return;
      const turmaData = dadosTurmas[turmaAtual];
      const container = document.getElementById('checkboxContainer');
      container.innerHTML = '';
      turmaData.escalaAtual.forEach(p => {
        const div = document.createElement('div');
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = `chk_${p.nome.replace(/\s+/g, '_')}`;
        checkbox.value = p.nome;
        checkbox.name = 'faltante';
        const label = document.createElement('label');
        label.htmlFor = checkbox.id;
        label.textContent = p.nome;
        div.appendChild(checkbox);
        div.appendChild(label);
        container.appendChild(div);
      });
      console.log(`Checkboxes montados para ${turmaAtual}:`, turmaData.escalaAtual.map(p => p.nome));
    }

    // Funções de laboratórios
    async function avancarRodizioLaboratorio() {
      if (!turmaAtual || !laboratorioAtual) {
        console.error('Erro: turmaAtual ou laboratorioAtual não definidos');
        return;
      }
      const labData = dadosTurmas[turmaAtual][laboratorioAtual];
      if (labData.grupos.length === 0) {
        console.log(`Nenhum grupo cadastrado para ${laboratorioAtual} em ${turmaAtual}`);
        return;
      }

      console.log(`Iniciando rodízio para ${laboratorioAtual} em ${turmaAtual}. Grupos antes:`, JSON.parse(JSON.stringify(labData.grupos)));

      // Obter as funções atuais na ordem dos grupos
      const funcoesAtuais = labData.grupos.map(g => g.funcao);

      // Rotacionar as funções: G1 -> G2, G2 -> G3, G3 -> G1, etc.
      const n = funcoesAtuais.length;
      const funcoesRotacionadas = new Array(n);
      for (let i = 0; i < n; i++) {
        funcoesRotacionadas[i] = funcoesAtuais[(i - 1 + n) % n];
      }

      // Aplicar as funções rotacionadas aos grupos
      labData.grupos.forEach((grupo, index) => {
        grupo.funcao = funcoesRotacionadas[index];
      });

      // Atualizar a posição do rodízio
      labData.posicaoUltimaFuncao = (labData.posicaoUltimaFuncao + 1) % (labData.grupos.length || 1);

      console.log(`Grupos após rodízio para ${laboratorioAtual} em ${turmaAtual}:`, JSON.parse(JSON.stringify(labData.grupos)));
      console.log(`Nova posicaoUltimaFuncao: ${labData.posicaoUltimaFuncao}`);

      // Salvar no Firestore
      try {
        await salvarLaboratorioNoFirestore(laboratorioAtual);
        console.log(`Rodízio salvo no Firestore para ${laboratorioAtual} em ${turmaAtual}`);
      } catch (error) {
        console.error(`Erro ao salvar rodízio no Firestore para ${laboratorioAtual}:`, error);
        alert(`Erro ao salvar rodízio do ${laboratorioAtual.toUpperCase()}. Verifique sua conexão.`);
      }

      // Atualizar a interface
      atualizarListaGruposLaboratorio();
    }

    function atualizarListaGruposLaboratorio() {
      if (!turmaAtual || !laboratorioAtual) return;
      const labData = dadosTurmas[turmaAtual][laboratorioAtual];
      const ul = document.getElementById('listaGruposLaboratorio');
      ul.innerHTML = '';
      if (labData.grupos.length === 0) {
        ul.innerHTML = '<li>Nenhum grupo cadastrado.</li>';
        return;
      }
      labData.grupos.forEach((grupo, idx) => {
        const li = document.createElement('li');
        li.textContent = `${grupo.nome} - ${grupo.funcao}`;
        if (isAdmin) {
          const btnEditar = document.createElement('button');
          btnEditar.textContent = 'Editar';
          btnEditar.className = 'editarGrupoBtn';
          btnEditar.addEventListener('click', () => {
            const novaFuncao = prompt('Digite a nova função para ' + grupo.nome, grupo.funcao);
            if (novaFuncao && novaFuncao.trim()) {
              labData.grupos[idx].funcao = novaFuncao.trim();
              salvarLaboratorioNoFirestore(laboratorioAtual).then(() => {
                atualizarListaGruposLaboratorio();
              });
            }
          });
          const btnRemover = document.createElement('button');
          btnRemover.textContent = 'Remover';
          btnRemover.className = 'removerGrupoBtn';
          btnRemover.addEventListener('click', async () => {
            labData.grupos.splice(idx, 1);
            await salvarLaboratorioNoFirestore(laboratorioAtual);
            atualizarListaGruposLaboratorio();
          });
          li.appendChild(btnEditar);
          li.appendChild(btnRemover);
        }
        ul.appendChild(li);
      });
    }

    // Funções de autenticação
    document.getElementById('btnMatutino').addEventListener('click', async function() {
      console.log('Botão Matutino clicado');
      turmaAtual = 'matutino';
      try {
        await lerDadosDoFirestore();
        console.log('Dados carregados para Matutino, mostrando telaInicial');
        mostrarTela('inicio');
      } catch (error) {
        console.error('Erro ao processar clique em Matutino:', error);
        mostrarTela('inicio');
      }
    });

    document.getElementById('btnVespertino').addEventListener('click', async function() {
      console.log('Botão Vespertino clicado');
      turmaAtual = 'vespertino';
      try {
        await lerDadosDoFirestore();
        console.log('Dados carregados para Vespertino, mostrando telaInicial');
        mostrarTela('inicio');
      } catch (error) {
        console.error('Erro ao processar clique em Vespertino:', error);
        mostrarTela('inicio');
      }
    });

    document.getElementById('btnProfessor').addEventListener('click', function() {
      mostrarTela('login');
    });

    document.getElementById('btnEstudante').addEventListener('click', function() {
      usuarioLogado = { email: null, tipo: 'estudante' };
      isAdmin = false;
      mostrarTela('painel');
    });

    document.getElementById('btnEntrar').addEventListener('click', function() {
      const email = document.getElementById('emailLogin').value.trim();
      const senha = document.getElementById('senhaLogin').value.trim();
      const mensagemErro = document.getElementById('mensagemErro');

      if (email.length === 0 || senha.length === 0) {
        mensagemErro.textContent = 'Preencha email e senha!';
        return;
      }

      auth.signInWithEmailAndPassword(email, senha)
        .then((userCredential) => {
          const user = userCredential.user;
          if (dadosTurmas[turmaAtual].admins.includes(user.email)) {
            usuarioLogado = { email: user.email, tipo: 'admin' };
            isAdmin = true;
            mensagemErro.textContent = '';
            if (adminConfig[user.email]?.primeiroLogin) {
              mostrarTela('minha-conta');
            } else {
              mostrarTela('painel');
            }
          } else {
            mensagemErro.textContent = 'Usuário não autorizado para esta turma.';
            auth.signOut();
          }
        })
        .catch((error) => {
          console.error('Erro de autenticação:', error);
          if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
            mensagemErro.textContent = 'Email ou senha incorretos.';
          } else if (error.code === 'auth/invalid-email') {
            mensagemErro.textContent = 'Email inválido.';
          } else {
            mensagemErro.textContent = 'Erro ao fazer login. Tente novamente.';
          }
        });
    });

    document.getElementById('btnVoltarLogin').addEventListener('click', function() {
      mostrarTela('selecao-turma');
    });

    document.getElementById('btnEsqueciSenha').addEventListener('click', function() {
      const email = document.getElementById('emailLogin').value.trim();
      const mensagemErro = document.getElementById('mensagemErro');

      if (!email) {
        mensagemErro.textContent = 'Digite seu email para redefinir a senha!';
        return;
      }

      auth.sendPasswordResetEmail(email)
        .then(() => {
          mensagemErro.textContent = 'Email de redefinição de senha enviado! Verifique sua caixa de entrada ou pasta de spam.';
        })
        .catch((error) => {
          console.error('Erro ao enviar email de redefinição:', error);
          if (error.code === 'auth/invalid-email') {
            mensagemErro.textContent = 'Email inválido.';
          } else if (error.code === 'auth/user-not-found') {
            mensagemErro.textContent = 'Email não registrado.';
          } else {
            mensagemErro.textContent = 'Erro ao enviar email de redefinição. Tente novamente.';
          }
        });
    });

    const menuBtn = document.getElementById('menuBtn');
    const menuLateral = document.getElementById('menuLateral');
    const fecharMenu = document.getElementById('fecharMenu');

    menuBtn.addEventListener('click', function() {
      if (isAdmin) {
        menuLateral.style.display = 'flex';
        menuLateral.classList.toggle('aberto');
      }
    });

    fecharMenu.addEventListener('click', function() {
      menuLateral.classList.remove('aberto');
      setTimeout(() => {
        menuLateral.style.display = 'none';
      }, 300);
    });

    document.getElementById('btnSair').addEventListener('click', function() {
      auth.signOut()
        .then(() => {
          usuarioLogado = null;
          isAdmin = false;
          turmaAtual = null;
          laboratorioAtual = null;
          mostrarTela('selecao-turma');
          console.log('Usuário deslogado com sucesso');
        })
        .catch((error) => {
          console.error('Erro ao deslogar:', error);
          alert('Erro ao sair. Tente novamente.');
        });
    });

    document.getElementById('btnContinuar').addEventListener('click', async function() {
      if (isAdmin) {
        console.log(`Botão Continuar clicado, gerando nova escala para ${turmaAtual}`);
        await gerarEscala();
      }
    });

    document.getElementById('btnGerenciarLaboratorios').addEventListener('click', function() {
      if (isAdmin) {
        mostrarTela('laboratorios');
      }
    });

    document.getElementById('btnLab303').addEventListener('click', function() {
      laboratorioAtual = 'lab303';
      mostrarTela('gerenciar-laboratorio');
    });

    document.getElementById('btnLab304').addEventListener('click', function() {
      laboratorioAtual = 'lab304';
      mostrarTela('gerenciar-laboratorio');
    });

    document.getElementById('btnLab303Estudante').addEventListener('click', function() {
      laboratorioAtual = 'lab303';
      mostrarTela('gerenciar-laboratorio');
    });

    document.getElementById('btnLab304Estudante').addEventListener('click', function() {
      laboratorioAtual = 'lab304';
      mostrarTela('gerenciar-laboratorio');
    });

    document.getElementById('btnVoltarEstudante').addEventListener('click', function() {
      usuarioLogado = null;
      isAdmin = false;
      turmaAtual = null;
      laboratorioAtual = null;
      mostrarTela('selecao-turma');
    });

    document.getElementById('btnVoltarLaboratorios').addEventListener('click', function() {
      mostrarTela('painel');
    });

    document.getElementById('btnAdicionarGrupo').addEventListener('click', async function() {
      if (!turmaAtual || !laboratorioAtual) return;
      const nomeGrupo = document.getElementById('nomeGrupoInput').value.trim();
      const funcaoGrupo = document.getElementById('funcaoGrupoInput').value.trim();
      const mensagemErro = document.getElementById('mensagemErroLaboratorio');

      if (!nomeGrupo || !funcaoGrupo) {
        mensagemErro.textContent = 'Preencha o nome e a função do grupo!';
        return;
      }

      const labData = dadosTurmas[turmaAtual][laboratorioAtual];
      if (labData.grupos.some(g => g.nome.toLowerCase() === nomeGrupo.toLowerCase())) {
        mensagemErro.textContent = 'Este nome de grupo já existe!';
        return;
      }

      labData.grupos.push({ nome: nomeGrupo, funcao: funcaoGrupo });
      document.getElementById('nomeGrupoInput').value = '';
      document.getElementById('funcaoGrupoInput').value = '';
      mensagemErro.textContent = '';
      await salvarLaboratorioNoFirestore(laboratorioAtual);
      atualizarListaGruposLaboratorio();
    });

    document.getElementById('btnAvancarRodizio').addEventListener('click', async function() {
      if (isAdmin) {
        await avancarRodizioLaboratorio();
      }
    });

    document.getElementById('btnVoltarGerenciarLaboratorio').addEventListener('click', function() {
      if (isAdmin) {
        mostrarTela('laboratorios');
      } else {
        mostrarTela('painel');
      }
    });

    document.getElementById('btnResetar').addEventListener('click', async function() {
      if (!turmaAtual || !isAdmin) return;
      if (confirm('Tem certeza que deseja resetar a escala? Isso apagará a escala atual, os faltantes pendentes e o histórico de tarefas.')) {
        const turmaData = dadosTurmas[turmaAtual];
        turmaData.escalaAtual = [];
        turmaData.faltantesPendentes = [];
        turmaData.historicoTarefa = {};
        turmaData.posicaoUltimaEscala = -1;
        try {
          await salvarEscalaNoFirestore();
          atualizarResultadoEFormulario();
          alert('Escala resetada com sucesso!');
          menuLateral.classList.remove('aberto');
          setTimeout(() => {
            menuLateral.style.display = 'none';
          }, 300);
        } catch (error) {
          console.error('Erro ao resetar escala:', error);
          alert('Erro ao resetar a escala. Verifique sua conexão.');
        }
      }
    });

    document.getElementById('formQuemLimpou').addEventListener('submit', async function(e) {
      e.preventDefault();
      if (!turmaAtual) return;
      console.log(`Evento submit disparado em formQuemLimpou para ${turmaAtual}`);

      const turmaData = dadosTurmas[turmaAtual];
      const checkboxes = document.querySelectorAll('#checkboxContainer input[name="faltante"]:checked');
      console.log('Checkboxes marcados:', checkboxes.length, Array.from(checkboxes).map(cb => cb.value));

      if (checkboxes.length === 0) {
        console.log('Nenhum faltante selecionado, mantendo escala atual');
        await salvarEscalaNoFirestore();
        atualizarResultadoEFormulario();
        return;
      }

      const escalaAntes = [...turmaData.escalaAtual];
      const faltantes = Array.from(checkboxes).map(cb => {
        const pessoa = turmaData.escalaAtual.find(p => p.nome === cb.value);
        return pessoa ? { nome: pessoa.nome, tarefa: pessoa.tarefa, index: pessoa.index } : null;
      }).filter(p => p !== null);

      // Adicionar faltantes à lista de pendentes antes de remover da escala
      turmaData.faltantesPendentes.push(...faltantes);
      console.log(`Faltantes adicionados aos pendentes:`, turmaData.faltantesPendentes);

      // Remover faltantes da escala atual e substituir
      for (let faltante of faltantes) {
        substituirPessoaNaEscala(faltante.nome, faltante.tarefa);
      }

      // Reordenar a escala para manter a ordem alfabética
      turmaData.escalaAtual.sort((a, b) => a.index - b.index);

      console.log(`Escala final para ${turmaAtual}:`, turmaData.escalaAtual);
      console.log(`Faltantes pendentes:`, turmaData.faltantesPendentes);
      console.log(`Histórico de tarefas:`, turmaData.historicoTarefa);
      console.log(`Escala antes vs depois:`, { antes: escalaAntes, depois: turmaData.escalaAtual });

      await salvarEscalaNoFirestore();
      atualizarResultadoEFormulario();
    });

    // Funções de edição de nomes
    document.getElementById('btnEditarNomes').addEventListener('click', function() {
      mostrarTela('editar-nomes');
    });

    document.getElementById('btnVoltarEdicao').addEventListener('click', function() {
      mostrarTela('painel');
    });

    function atualizarListaNomesEdicao() {
      if (!turmaAtual) return;
      const turmaData = dadosTurmas[turmaAtual];
      const ul = document.getElementById('listaNomesEdicao');
      ul.innerHTML = '';
      turmaData.nomes.forEach((nome, idx) => {
        const li = document.createElement('li');
        li.textContent = nome;
        const btnRemover = document.createElement('button');
        btnRemover.textContent = 'Remover';
        btnRemover.className = 'removerNomeBtn';
        btnRemover.addEventListener('click', async () => {
          const pessoaNaEscala = turmaData.escalaAtual.find(p => p.nome === nome);
          const indexNaLista = turmaData.nomes.indexOf(nome);
          turmaData.nomes.splice(indexNaLista, 1);
          
          // Ajustar índices na escala atual e faltantes pendentes
          turmaData.escalaAtual.forEach(p => {
            if (p.index > indexNaLista) p.index--;
          });
          turmaData.faltantesPendentes.forEach(f => {
            if (f.index > indexNaLista) f.index--;
          });
          
          if (pessoaNaEscala && turmaData.nomes.length > 0) {
            substituirPessoaNaEscala(nome, pessoaNaEscala.tarefa);
          } else {
            turmaData.escalaAtual = turmaData.escalaAtual.filter(p => p.nome !== nome);
            turmaData.faltantesPendentes = turmaData.faltantesPendentes.filter(f => f.nome !== nome);
          }
          await salvarConfigNoFirestore();
          await salvarEscalaNoFirestore();
          atualizarListaNomesEdicao();
          atualizarResultadoEFormulario();
        });
        li.appendChild(btnRemover);
        ul.appendChild(li);
      });
    }

    document.getElementById('btnAdicionarNome').addEventListener('click', async function() {
      if (!turmaAtual) return;
      const input = document.getElementById('novoNomeInput');
      const novoNome = input.value.trim();
      const turmaData = dadosTurmas[turmaAtual];
      if (novoNome.length > 0 && !turmaData.nomes.some(n => n.toLowerCase() === novoNome.toLowerCase())) {
        turmaData.nomes.push(novoNome);
        turmaData.nomes.sort((a, b) => a.localeCompare(b));
        input.value = '';

        // Verificar se a nova pessoa deve ser adicionada à escala
        const idxNovoNome = turmaData.nomes.indexOf(novoNome);
        let usados = turmaData.escalaAtual.map(p => p.nome).concat(turmaData.faltantesPendentes.map(f => f.nome));

        if (turmaData.escalaAtual.length < 2 && turmaData.nomes.length > usados.length) {
          // Escala incompleta, adicionar o novo nome se possível
          if (!usados.includes(novoNome)) {
            const tarefa = turmaData.escalaAtual.length === 0 ? 'chão' : (turmaData.escalaAtual[0].tarefa === 'mesa' ? 'chão' : 'mesa');
            turmaData.escalaAtual.push({ nome: novoNome, tarefa, index: idxNovoNome });
            turmaData.historicoTarefa[novoNome] = tarefa;
            turmaData.posicaoUltimaEscala = idxNovoNome;
            console.log(`Novo nome ${novoNome} adicionado à escala: ${tarefa}`);
          }
        } else if (turmaData.escalaAtual.length === 2) {
          // Escala completa, verificar se o novo nome deve substituir alguém
          const [primeiraPessoa, segundaPessoa] = turmaData.escalaAtual;
          const idxPrimeira = primeiraPessoa.index;
          const idxSegunda = segundaPessoa.index;

          if (idxNovoNome > idxPrimeira && idxNovoNome < idxSegunda && !usados.includes(novoNome)) {
            // Novo nome está entre a primeira e a segunda pessoa na ordem alfabética
            turmaData.escalaAtual = [primeiraPessoa, { nome: novoNome, tarefa: segundaPessoa.tarefa, index: idxNovoNome }];
            turmaData.historicoTarefa[novoNome] = segundaPessoa.tarefa;
            turmaData.posicaoUltimaEscala = idxNovoNome;
            console.log(`Novo nome ${novoNome} substituiu ${segundaPessoa.nome} na escala`);
          } else {
            console.log(`Novo nome ${novoNome} não substitui ninguém, apenas adicionado à lista`);
          }
        }

        await salvarConfigNoFirestore();
        await salvarEscalaNoFirestore();
        atualizarListaNomesEdicao();
        atualizarResultadoEFormulario();
      } else {
        alert('Nome inválido ou já existe!');
      }
    });

    document.getElementById('btnZerarNomes').addEventListener('click', async function() {
      if (!turmaAtual) return;
      if (confirm('Tem certeza que quer apagar todos os nomes?')) {
        const turmaData = dadosTurmas[turmaAtual];
        turmaData.nomes = [];
        turmaData.escalaAtual = [];
        turmaData.faltantesPendentes = [];
        await salvarConfigNoFirestore();
        await salvarEscalaNoFirestore();
        atualizarListaNomesEdicao();
        mostrarTela('painel');
        atualizarResultadoEFormulario();
        alert('Lista de nomes zerada com sucesso!');
      }
    });

    // Funções de gerenciamento de administradores
    document.getElementById('btnLiberarAcesso').addEventListener('click', function() {
      if (isAdmin) {
        mostrarTela('gerenciar-admins');
      }
    });

    document.getElementById('btnVoltarAdmins').addEventListener('click', function() {
      mostrarTela('painel');
    });

    function atualizarListaAdminsEdicao() {
      if (!turmaAtual) return;
      const ul = document.getElementById('listaAdminsEdicao');
      ul.innerHTML = '';
      const admins = dadosTurmas[turmaAtual].admins;
      admins.forEach((email, idx) => {
        const li = document.createElement('li');
        li.textContent = email;
        if (email === ADMIN_PERMANENTE) {
          const spanCriador = document.createElement('span');
          spanCriador.textContent = 'Criador';
          spanCriador.className = 'criador';
          li.appendChild(spanCriador);
        } else {
          const btnRemover = document.createElement('button');
          btnRemover.textContent = 'Remover';
          btnRemover.className = 'removerAdminBtn';
          btnRemover.addEventListener('click', () => {
            if (admins.length <= 1) {
              alert('Não é possível remover o último administrador!');
              return;
            }
            if (usuarioLogado.email === email) {
              alert('Você não pode remover seu próprio email!');
              return;
            }
            admins.splice(idx, 1);
            atualizarListaAdminsEdicao();
            salvarConfigNoFirestore();
          });
          li.appendChild(btnRemover);
        }
        ul.appendChild(li);
      });
    }

    document.getElementById('btnAdicionarAdmin').addEventListener('click', async function() {
      if (!turmaAtual) return;
      const inputEmail = document.getElementById('novoAdminInput');
      const inputSenha = document.getElementById('novaSenhaAdminInput');
      const novoEmail = inputEmail.value.trim();
      const novaSenha = inputSenha.value.trim();
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

      if (!novoEmail || !emailRegex.test(novoEmail)) {
        alert('Digite um email válido!');
        return;
      }
      const admins = dadosTurmas[turmaAtual].admins;
      if (admins.includes(novoEmail)) {
        alert('Este email já está na lista de administradores!');
        return;
      }
      if (novaSenha.length < 6) {
        alert('A senha deve ter pelo menos 6 caracteres!');
        return;
      }

      try {
        await auth.createUserWithEmailAndPassword(novoEmail, novaSenha);
        admins.push(novoEmail);
        adminConfig[novoEmail] = { primeiroLogin: true };
        await salvarConfigNoFirestore();
        atualizarListaAdminsEdicao();
        inputEmail.value = '';
        inputSenha.value = '';
        alert('Administrador adicionado com sucesso!');
      } catch (error) {
        console.error('Erro ao adicionar administrador:', error);
        if (error.code === 'auth/email-already-in-use') {
          alert('Este email já está registrado!');
        } else {
          alert('Erro ao adicionar administrador. Tente novamente.');
        }
      }
    });

    // Funções de gerenciamento de conta
    document.getElementById('btnMinhaConta').addEventListener('click', function() {
      if (isAdmin) {
        mostrarTela('minha-conta');
      }
    });

    document.getElementById('btnVoltarMinhaConta').addEventListener('click', function() {
      mostrarTela('painel');
    });

    function atualizarTelaMinhaConta() {
      const mensagemAviso = document.getElementById('mensagemAviso');
      const mensagemErro = document.getElementById('mensagemErroMinhaConta');
      mensagemAviso.textContent = adminConfig[usuarioLogado.email]?.primeiroLogin ? 'Você precisa alterar sua senha no primeiro login.' : '';
      mensagemErro.textContent = '';
      document.getElementById('novaSenhaInput').value = '';
      document.getElementById('confirmarSenhaInput').value = '';
    }

    document.getElementById('btnAlterarSenha').addEventListener('click', async function() {
      const novaSenha = document.getElementById('novaSenhaInput').value.trim();
      const confirmarSenha = document.getElementById('confirmarSenhaInput').value.trim();
      const mensagemErro = document.getElementById('mensagemErroMinhaConta');

      if (novaSenha.length < 6) {
        mensagemErro.textContent = 'A senha deve ter pelo menos 6 caracteres!';
        return;
      }
      if (novaSenha !== confirmarSenha) {
        mensagemErro.textContent = 'As senhas não coincidem!';
        return;
      }

      try {
        const user = auth.currentUser;
        await user.updatePassword(novaSenha);
        adminConfig[usuarioLogado.email] = { primeiroLogin: false };
        await salvarConfigNoFirestore();
        mensagemErro.textContent = '';
        alert('Senha alterada com sucesso!');
        mostrarTela('painel');
      } catch (error) {
        console.error('Erro ao alterar senha:', error);
        if (error.code === 'auth/requires-recent-login') {
          mensagemErro.textContent = 'Por segurança, faça login novamente antes de alterar a senha.';
        } else {
          mensagemErro.textContent = 'Erro ao alterar a senha. Tente novamente.';
        }
      }
    });
  </script>
</body>
</html>
