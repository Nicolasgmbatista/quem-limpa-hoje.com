<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Quem Limpa a Sala Hoje? - Alimentos</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .modal {
      transition: opacity 0.3s ease, transform 0.3s ease;
    }
    .modal-hidden {
      opacity: 0;
      transform: translateY(-20px);
      pointer-events: none;
    }
    .modal-visible {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }
    .sidebar {
      transition: transform 0.3s ease;
    }
    .sidebar-hidden {
      transform: translateX(100%);
    }
    .sidebar-visible {
      transform: translateX(0);
    }
    .theme-toggle {
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    [data-theme="dark"] {
      background-color: #1f2937;
      color: #f3f4f6;
    }
    [data-theme="dark"] input,
    [data-theme="dark"] button {
      background-color: #374151;
      color: #f3f4f6;
      border-color: #4b5563;
    }
    [data-theme="dark"] input:focus,
    [data-theme="dark"] button:hover {
      background-color: #4b5563;
    }
  </style>
</head>
<body class="bg-gray-100 font-sans text-gray-900 min-h-screen flex justify-center p-4" data-theme="light">
  <div id="app" class="w-full max-w-md bg-white rounded-xl shadow-lg p-6 relative">
    <!-- Tela inicial com lista de salas -->
    <div id="telaInicial">
      <h1 class="text-2xl font-bold text-center mb-4">Quem Limpa a Sala Hoje? - Alimentos</h1>
      <div id="salasContainer" class="space-y-4"></div>
      <button id="btnCriarSala" class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition mt-4">Criar Nova Sala</button>
      <button id="themeToggle" class="absolute top-4 right-4 p-2 rounded-full bg-gray-200 hover:bg-gray-300 transition">üåô</button>
    </div>

    <!-- Tela de login -->
    <div id="telaLogin" class="hidden flex flex-col items-center gap-4">
      <h1 class="text-2xl font-bold">Login - Professor / Representante</h1>
      <div id="mensagemErro" class="text-red-600 font-medium"></div>
      <input type="email" id="emailLogin" placeholder="Email" autocomplete="username" class="w-full max-w-xs p-3 border-2 border-gray-300 rounded-lg focus:border-green-600" />
      <input type="password" id="senhaLogin" placeholder="Senha" autocomplete="current-password" class="w-full max-w-xs p-3 border-2 border-gray-300 rounded-lg focus:border-green-600" />
      <div class="flex gap-2 w-full max-w-xs">
        <button id="btnEntrar" class="flex-1 bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition">Entrar</button>
        <button id="btnVoltarLogin" class="flex-1 bg-gray-600 text-white py-3 rounded-lg hover:bg-gray-700 transition">Voltar</button>
      </div>
      <button id="btnEsqueciSenha" class="text-green-600 underline text-sm hover:text-green-700">Esqueci minha senha</button>
    </div>

    <!-- Tela principal da escala -->
    <div id="conteudoEscala" class="hidden">
      <button id="menuBtn" title="Abrir menu" class="absolute top-4 right-4 text-2xl">‚ò∞</button>
      <h1 class="text-2xl font-bold text-center mb-4">Escala da Sala: <span id="nomeSala"></span></h1>
      <div id="resultado" class="mb-6">
        <h2 class="text-xl font-semibold mb-2">Escala de Hoje:</h2>
        <ul id="listaEscala" class="space-y-2"></ul>
        <button id="btnContinuar" class="w-full max-w-xs bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition mt-4 mx-auto block">Continuar</button>
      </div>
      <div id="pergunta" class="hidden">
        <p class="mb-4">Selecione quem <strong>faltou</strong> ou <strong>limpou</strong> e clique em "Confirmar":</p>
        <form id="formQuemLimpou" class="space-y-4">
          <div id="checkboxContainer" class="flex flex-wrap gap-4 justify-center"></div>
          <button type="submit" class="w-full max-w-xs bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition mx-auto">Confirmar</button>
        </form>
      </div>
      <div id="laboratorioSection" class="mt-6 hidden">
        <h2 class="text-xl font-semibold mb-2">Configura√ß√£o de Laborat√≥rio</h2>
        <button id="btnConfigLaboratorio" class="w-full max-w-xs bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition mx-auto">Configurar Grupos</button>
      </div>
    </div>

    <!-- Menu lateral -->
    <nav id="menuLateral" class="fixed top-0 right-0 w-64 h-full bg-gray-800 text-white p-4 sidebar sidebar-hidden">
      <button id="fecharMenu" class="w-full bg-gray-700 py-3 rounded-lg hover:bg-gray-600 transition mb-4">Voltar</button>
      <button id="btnMinhaConta" class="w-full bg-gray-700 py-3 rounded-lg hover:bg-gray-600 transition mb-2">Minha Conta</button>
      <button id="btnEditarNomes" class="w-full bg-gray-700 py-3 rounded-lg hover:bg-gray-600 transition mb-2">Editar Nomes</button>
      <button id="btnLiberarAcesso" class="w-full bg-gray-700 py-3 rounded-lg hover:bg-gray-600 transition mb-2">Liberar Acesso</button>
      <button id="btnResetar" class="w-full bg-red-600 py-3 rounded-lg hover:bg-red-700 transition mb-2">Resetar Escala</button>
      <button id="btnSair" class="w-full bg-gray-700 py-3 rounded-lg hover:bg-gray-600 transition">Sair</button>
    </nav>

    <!-- Tela para edi√ß√£o de nomes -->
    <div id="telaEditarNomes" class="hidden flex flex-col items-center">
      <h2 class="text-xl font-semibold mb-4">Editar Nomes - <span id="nomeSalaEdicao"></span></h2>
      <ul id="listaNomesEdicao" class="w-full max-h-64 overflow-y-auto border border-gray-300 rounded-lg bg-gray-50 mb-4"></ul>
      <div class="w-full max-w-xs mb-4">
        <input type="text" id="novoNomeInput" placeholder="Digite novo nome" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-green-600" />
        <button id="btnAdicionarNome" class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition mt-2">Adicionar</button>
      </div>
      <button id="btnZerarNomes" class="w-full max-w-xs bg-red-600 text-white py-3 rounded-lg hover:bg-red-700 transition">Zerar</button>
      <button id="btnVoltarEdicao" class="w-full max-w-xs bg-gray-600 text-white py-3 rounded-lg hover:bg-gray-700 transition mt-2">Voltar</button>
    </div>

    <!-- Tela para gerenciar administradores -->
    <div id="telaGerenciarAdmins" class="hidden flex flex-col items-center">
      <h2 class="text-xl font-semibold mb-4">Gerenciar Administradores - <span id="nomeSalaAdmins"></span></h2>
      <ul id="listaAdminsEdicao" class="w-full max-h-64 overflow-y-auto border border-gray-300 rounded-lg bg-gray-50 mb-4"></ul>
      <div class="w-full max-w-xs mb-4">
        <input type="email" id="novoAdminInput" placeholder="Digite novo email" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-green-600" />
        <input type="password" id="novaSenhaAdminInput" placeholder="Senha inicial" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-green-600 mt-2" />
        <button id="btnAdicionarAdmin" class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition mt-2">Adicionar</button>
      </div>
      <button id="btnSalvarAdmins" class="w-full max-w-xs bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition">Salvar</button>
      <button id="btnVoltarAdmins" class="w-full max-w-xs bg-gray-600 text-white py-3 rounded-lg hover:bg-gray-700 transition mt-2">Voltar</button>
    </div>

    <!-- Tela para minha conta -->
    <div id="telaMinhaConta" class="hidden flex flex-col items-center">
      <h2 class="text-xl font-semibold mb-4">Minha Conta</h2>
      <div id="mensagemAviso" class="text-yellow-600 font-medium mb-4"></div>
      <div id="mensagemErroMinhaConta" class="text-red-600 font-medium mb-4"></div>
      <div class="w-full max-w-xs mb-4">
        <input type="password" id="novaSenhaInput" placeholder="Nova senha" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-green-600" />
        <input type="password" id="confirmarSenhaInput" placeholder="Confirmar nova senha" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-green-600 mt-2" />
        <button id="btnAlterarSenha" class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition mt-2">Alterar Senha</button>
      </div>
      <button id="btnVoltarMinhaConta" class="w-full max-w-xs bg-gray-600 text-white py-3 rounded-lg hover:bg-gray-700 transition">Voltar</button>
    </div>

    <!-- Modal para configura√ß√£o de laborat√≥rio -->
    <div id="modalLaboratorio" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center modal modal-hidden">
      <div class="bg-white p-6 rounded-xl shadow-lg w-full max-w-md">
        <h2 class="text-xl font-semibold mb-4">Configurar Grupos de Laborat√≥rio</h2>
        <div class="mb-4">
          <label for="qtdGrupos" class="block text-sm font-medium mb-1">Quantidade de Grupos:</label>
          <input type="number" id="qtdGrupos" min="1" max="10" value="1" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-green-600" />
        </div>
        <div id="gruposContainer" class="space-y-4"></div>
        <div class="flex gap-2 mt-4">
          <button id="btnSalvarLaboratorio" class="flex-1 bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition">Salvar</button>
          <button id="btnCancelarLaboratorio" class="flex-1 bg-gray-600 text-white py-3 rounded-lg hover:bg-gray-700 transition">Cancelar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyAGkdnFfJNw4r6yYpSGIpgjwISBOppwR60",
      authDomain: "quem-limpa-hoje.firebaseapp.com",
      projectId: "quem-limpa-hoje",
      storageBucket: "quem-limpa-hoje.firebasestorage.app",
      messagingSenderId: "44929275404",
      appId: "1:44929275404:web:971258e864925cb3684029"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // Vari√°veis globais
    let usuarioLogado = null;
    let isAdmin = false;
    let isSuperAdmin = false;
    let telaAtual = 'inicio';
    let salas = [];
    let salaAtual = null;
    let adminConfig = {};

    // Fun√ß√µes para mostrar/ocultar telas
    function mostrarTela(t) {
      telaAtual = t;
      document.getElementById('telaInicial').classList.add('hidden');
      document.getElementById('telaLogin').classList.add('hidden');
      document.getElementById('conteudoEscala').classList.add('hidden');
      document.getElementById('telaEditarNomes').classList.add('hidden');
      document.getElementById('telaGerenciarAdmins').classList.add('hidden');
      document.getElementById('telaMinhaConta').classList.add('hidden');
      document.getElementById('menuLateral').classList.remove('sidebar-visible');
      document.getElementById('menuLateral').classList.add('sidebar-hidden');
      document.getElementById('modalLaboratorio').classList.add('modal-hidden');
      document.getElementById('modalLaboratorio').classList.remove('modal-visible');

      switch (t) {
        case 'inicio':
          document.getElementById('telaInicial').classList.remove('hidden');
          atualizarListaSalas();
          break;
        case 'login':
          document.getElementById('telaLogin').classList.remove('hidden');
          document.getElementById('emailLogin').value = '';
          document.getElementById('senhaLogin').value = '';
          document.getElementById('mensagemErro').textContent = '';
          break;
        case 'painel':
          document.getElementById('conteudoEscala').classList.remove('hidden');
          document.getElementById('menuBtn').classList.toggle('hidden', !isAdmin);
          document.getElementById('pergunta').classList.toggle('hidden', !isAdmin);
          document.getElementById('laboratorioSection').classList.toggle('hidden', !isAdmin);
          atualizarResultadoEFormulario();
          if (isAdmin) montarCheckboxFaltantes();
          break;
        case 'editar-nomes':
          document.getElementById('telaEditarNomes').classList.remove('hidden');
          atualizarListaNomesEdicao();
          break;
        case 'gerenciar-admins':
          document.getElementById('telaGerenciarAdmins').classList.remove('hidden');
          atualizarListaAdminsEdicao();
          break;
        case 'minha-conta':
          document.getElementById('telaMinhaConta').classList.remove('hidden');
          atualizarTelaMinhaConta();
          break;
      }
      console.log(`Tela atual: ${telaAtual}`);
    }

    // Fun√ß√µes de persist√™ncia
    async function salvarEscalaNoFirestore() {
      if (!salaAtual) return;
      try {
        await db.collection('salas').doc(salaAtual.id).collection('escala').doc('dados').set({
          posicaoUltimaEscala: salaAtual.posicaoUltimaEscala,
          historicoTarefa: salaAtual.historicoTarefa,
          escalaAtual: salaAtual.escalaAtual,
          faltantesPendentes: salaAtual.faltantesPendentes
        });
        console.log(`Escala salva para sala ${salaAtual.id}`);
      } catch (error) {
        console.error("Erro ao salvar escala:", error);
        alert("Erro ao salvar a escala. Verifique sua conex√£o.");
      }
    }

    async function salvarConfigNoFirestore() {
      if (!salaAtual) return;
      try {
        await db.collection('salas').doc(salaAtual.id).collection('config').doc('dados').set({
          nomes: salaAtual.nomes,
          admins: salaAtual.admins,
          adminConfig: adminConfig
        });
        console.log(`Config salva para sala ${salaAtual.id}`);
      } catch (error) {
        console.error("Erro ao salvar config:", error);
        alert("Erro ao salvar configura√ß√µes. Verifique sua conex√£o.");
      }
    }

    async function carregarSalas() {
      try {
        const snapshot = await db.collection('salas').get();
        salas = [];
        for (const doc of snapshot.docs) {
          if (isSuperAdmin || doc.data().admins.includes(usuarioLogado.email)) {
            const configDoc = await db.collection('salas').doc(doc.id).collection('config').doc('dados').get();
            const escalaDoc = await db.collection('salas').doc(doc.id).collection('escala').doc('dados').get();
            salas.push({
              id: doc.id,
              nome: doc.data().nome,
              admins: configDoc.exists ? configDoc.data().admins : [],
              nomes: configDoc.exists ? configDoc.data().nomes : [],
              adminConfig: configDoc.exists ? configDoc.data().adminConfig : {},
              posicaoUltimaEscala: escalaDoc.exists ? escalaDoc.data().posicaoUltimaEscala : -1,
              historicoTarefa: escalaDoc.exists ? escalaDoc.data().historicoTarefa : {},
              escalaAtual: escalaDoc.exists ? escalaDoc.data().escalaAtual : [],
              faltantesPendentes: escalaDoc.exists ? escalaDoc.data().faltantesPendentes : []
            });
          }
        }
        console.log('Salas carregadas:', salas);
        atualizarListaSalas();
      } catch (error) {
        console.error("Erro ao carregar salas:", error);
        alert("Erro ao carregar salas. Verifique sua conex√£o.");
      }
    }

    async function carregarLaboratorio(data) {
      if (!salaAtual) return;
      try {
        const doc = await db.collection('salas').doc(salaAtual.id).collection('laboratorio').doc(data).get();
        if (doc.exists) {
          return doc.data().grupos || [];
        }
        return [];
      } catch (error) {
        console.error("Erro ao carregar laborat√≥rio:", error);
        return [];
      }
    }

    async function salvarLaboratorio(data, grupos) {
      if (!salaAtual) return;
      try {
        await db.collection('salas').doc(salaAtual.id).collection('laboratorio').doc(data).set({ grupos });
        console.log(`Laborat√≥rio salvo para ${data} na sala ${salaAtual.id}`);
      } catch (error) {
        console.error("Erro ao salvar laborat√≥rio:", error);
        alert("Erro ao salvar configura√ß√£o de laborat√≥rio. Verifique sua conex√£o.");
      }
    }

    // Fun√ß√µes da escala
    function proximoIndice(atual, ignorados = [], nomes = salaAtual.nomes) {
      let i = atual;
      for (let c = 0; c < nomes.length; c++) {
        i = (i + 1) % nomes.length;
        if (!ignorados.includes(nomes[i])) return i;
      }
      return -1;
    }

    async function gerarEscala() {
      if (!salaAtual || salaAtual.nomes.length === 0) {
        salaAtual.escalaAtual = [];
        document.getElementById('listaEscala').innerHTML = '<li class="bg-gray-100 p-3 rounded-lg">Nenhum nome cadastrado.</li>';
        document.getElementById('pergunta').classList.toggle('hidden', !isAdmin);
        document.getElementById('btnContinuar').classList.toggle('hidden', !isAdmin);
        await salvarEscalaNoFirestore();
        return;
      }

      salaAtual.escalaAtual = [...salaAtual.faltantesPendentes];
      let usados = salaAtual.escalaAtual.map(p => p.nome);
      let idx = salaAtual.posicaoUltimaEscala;

      while (salaAtual.escalaAtual.length < 2 && salaAtual.nomes.length > usados.length) {
        idx = proximoIndice(idx, usados);
        if (idx === -1) break;
        const nome = salaAtual.nomes[idx];
        const ultimaTarefa = salaAtual.historicoTarefa[nome];
        let tarefa = salaAtual.escalaAtual.length === 0 
          ? (ultimaTarefa === 'ch√£o' ? 'mesa' : 'ch√£o')
          : (salaAtual.escalaAtual[0].tarefa === 'mesa' ? 'ch√£o' : 'mesa');
        salaAtual.escalaAtual.push({ nome, tarefa, index: idx });
        salaAtual.historicoTarefa[nome] = tarefa;
        usados.push(nome);
        salaAtual.posicaoUltimaEscala = idx;
      }

      salaAtual.faltantesPendentes = [];
      await salvarEscalaNoFirestore();
      atualizarResultadoEFormulario();
    }

    function substituirPessoaNaEscala(nomeRemovido, tarefa) {
      if (!salaAtual || salaAtual.nomes.length === 0) {
        salaAtual.escalaAtual = [];
        salaAtual.faltantesPendentes = salaAtual.faltantesPendentes.filter(f => f.nome !== nomeRemovido);
        return;
      }

      let usados = salaAtual.escalaAtual.map(p => p.nome).concat(salaAtual.faltantesPendentes.map(f => f.nome));
      let idx = salaAtual.posicaoUltimaEscala;
      idx = proximoIndice(idx, usados);
      if (idx === -1) {
        salaAtual.escalaAtual = salaAtual.escalaAtual.filter(p => p.nome !== nomeRemovido);
        salaAtual.faltantesPendentes = salaAtual.faltantesPendentes.filter(f => f.nome !== nomeRemovido);
        return;
      }

      const novoNome = salaAtual.nomes[idx];
      salaAtual.escalaAtual = salaAtual.escalaAtual.filter(p => p.nome !== nomeRemovido);
      salaAtual.escalaAtual.push({ nome: novoNome, tarefa, index: idx });
      salaAtual.historicoTarefa[novoNome] = tarefa;
      salaAtual.posicaoUltimaEscala = idx;
      salaAtual.faltantesPendentes = salaAtual.faltantesPendentes.filter(f => f.nome !== nomeRemovido);
    }

    function adicionarPessoaNaEscala(novoNome) {
      if (!salaAtual || salaAtual.nomes.length === 0) return;

      let usados = salaAtual.escalaAtual.map(p => p.nome).concat(salaAtual.faltantesPendentes.map(f => f.nome));
      if (usados.includes(novoNome)) return;

      const idxNovoNome = salaAtual.nomes.indexOf(novoNome);
      if (idxNovoNome === -1) return;

      if (salaAtual.escalaAtual.length === 0) {
        const tarefa = salaAtual.historicoTarefa[novoNome] === 'ch√£o' ? 'mesa' : 'ch√£o';
        salaAtual.escalaAtual.push({ nome: novoNome, tarefa, index: idxNovoNome });
        salaAtual.historicoTarefa[novoNome] = tarefa;
        salaAtual.posicaoUltimaEscala = idxNovoNome;
        return;
      }

      if (salaAtual.escalaAtual.length === 1) {
        const tarefa = salaAtual.escalaAtual[0].tarefa === 'mesa' ? 'ch√£o' : 'mesa';
        salaAtual.escalaAtual.push({ nome: novoNome, tarefa, index: idxNovoNome });
        salaAtual.historicoTarefa[novoNome] = tarefa;
        salaAtual.posicaoUltimaEscala = idxNovoNome;
        return;
      }

      const idxPrimeiro = salaAtual.escalaAtual[0].index;
      const proximaPessoaIdx = proximoIndice(idxPrimeiro, usados);
      if (proximaPessoaIdx === idxNovoNome) {
        const tarefa = salaAtual.escalaAtual[1].tarefa;
        salaAtual.escalaAtual = [salaAtual.escalaAtual[0], { nome: novoNome, tarefa, index: idxNovoNome }];
        salaAtual.historicoTarefa[novoNome] = tarefa;
        salaAtual.posicaoUltimaEscala = idxNovoNome;
      }
    }

    function atualizarResultadoEFormulario() {
      if (!salaAtual) return;
      const listaEscala = document.getElementById('listaEscala');
      listaEscala.innerHTML = '';
      document.getElementById('nomeSala').textContent = salaAtual.nome;
      if (salaAtual.escalaAtual.length === 0) {
        listaEscala.innerHTML = '<li class="bg-gray-100 p-3 rounded-lg">Nenhuma escala dispon√≠vel.</li>';
        document.getElementById('pergunta').classList.toggle('hidden', !isAdmin);
        document.getElementById('btnContinuar').classList.toggle('hidden', !isAdmin);
      } else {
        salaAtual.escalaAtual.forEach(p => {
          const li = document.createElement('li');
          li.className = 'bg-gray-100 p-3 rounded-lg flex justify-between';
          li.textContent = `${p.nome} - ${p.tarefa}`;
          listaEscala.appendChild(li);
        });
        document.getElementById('pergunta').classList.toggle('hidden', !isAdmin);
        document.getElementById('btnContinuar').classList.toggle('hidden', !isAdmin);
        if (isAdmin) montarCheckboxFaltantes();
      }
    }

    function montarCheckboxFaltantes() {
      if (!salaAtual) return;
      const container = document.getElementById('checkboxContainer');
      container.innerHTML = '';
      salaAtual.escalaAtual.forEach(p => {
        const div = document.createElement('div');
        div.className = 'flex items-center gap-2';
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = `chk_${p.nome.replace(/\s+/g, '_')}`;
        checkbox.value = p.nome;
        checkbox.name = 'faltante';
        checkbox.className = 'h-5 w-5';
        const label = document.createElement('label');
        label.htmlFor = checkbox.id;
        label.textContent = p.nome;
        label.className = 'text-sm';
        div.appendChild(checkbox);
        div.appendChild(label);
        container.appendChild(div);
      });
    }

    // Fun√ß√µes de gerenciamento de salas
    function atualizarListaSalas() {
      const container = document.getElementById('salasContainer');
      container.innerHTML = '';
      salas.forEach(sala => {
        const div = document.createElement('div');
        div.className = 'bg-gray-100 p-4 rounded-lg flex justify-between items-center';
        div.innerHTML = `
          <span class="font-medium">${sala.nome}</span>
          <button class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition" onclick="selecionarSala('${sala.id}')">Acessar</button>
        `;
        container.appendChild(div);
      });
    }

    async function selecionarSala(salaId) {
      salaAtual = salas.find(s => s.id === salaId);
      if (!salaAtual) return;
      mostrarTela('painel');
      document.getElementById('nomeSala').textContent = salaAtual.nome;
      document.getElementById('nomeSalaEdicao').textContent = salaAtual.nome;
      document.getElementById('nomeSalaAdmins').textContent = salaAtual.nome;
      atualizarResultadoEFormulario();
    }

    // Fun√ß√µes de laborat√≥rio
    function atualizarGruposLaboratorio(qtd) {
      const container = document.getElementById('gruposContainer');
      container.innerHTML = '';
      for (let i = 1; i <= qtd; i++) {
        const div = document.createElement('div');
        div.className = 'mb-4';
        div.innerHTML = `
          <label class="block text-sm font-medium mb-1">Grupo ${i} - Fun√ß√µes:</label>
          <input type="text" id="funcoesGrupo${i}" placeholder="Ex.: Prepara√ß√£o, Limpeza, An√°lise" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-green-600" />
        `;
        container.appendChild(div);
      }
    }

    // Fun√ß√µes de autentica√ß√£o
    document.getElementById('btnProfessor').addEventListener('click', () => {
      mostrarTela('login');
    });

    document.getElementById('btnEstudante').addEventListener('click', () => {
      usuarioLogado = { email: null, tipo: 'estudante' };
      isAdmin = false;
      isSuperAdmin = false;
      carregarSalas();
      mostrarTela('inicio');
    });

    document.getElementById('btnEntrar').addEventListener('click', () => {
      const email = document.getElementById('emailLogin').value.trim();
      const senha = document.getElementById('senhaLogin').value.trim();
      const mensagemErro = document.getElementById('mensagemErro');

      if (email.length === 0 || senha.length === 0) {
        mensagemErro.textContent = 'Preencha email e senha!';
        return;
      }

      auth.signInWithEmailAndPassword(email, senha)
        .then((userCredential) => {
          usuarioLogado = { email: userCredential.user.email, tipo: 'admin' };
          isSuperAdmin = usuarioLogado.email === 'nicolasgmbatista15@gmail.com';
          mensagemErro.textContent = '';
          carregarSalas().then(() => {
            if (adminConfig[usuarioLogado.email]?.primeiroLogin) {
              mostrarTela('minha-conta');
            } else {
              mostrarTela('inicio');
            }
          });
        })
        .catch((error) => {
          console.error('Erro de autentica√ß√£o:', error);
          mensagemErro.textContent = error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' 
            ? 'Email ou senha incorretos.'
            : error.code === 'auth/invalid-email' 
              ? 'Email inv√°lido.'
              : 'Erro ao fazer login. Tente novamente.';
        });
    });

    document.getElementById('btnVoltarLogin').addEventListener('click', () => {
      mostrarTela('inicio');
    });

    document.getElementById('btnEsqueciSenha').addEventListener('click', () => {
      const email = document.getElementById('emailLogin').value.trim();
      const mensagemErro = document.getElementById('mensagemErro');

      if (!email) {
        mensagemErro.textContent = 'Digite seu email para redefinir a senha!';
        return;
      }

      auth.sendPasswordResetEmail(email)
        .then(() => {
          mensagemErro.textContent = 'Email de redefini√ß√£o enviado! Verifique sua caixa de entrada ou spam.';
        })
        .catch((error) => {
          console.error('Erro ao enviar email de redefini√ß√£o:', error);
          mensagemErro.textContent = error.code === 'auth/invalid-email' 
            ? 'Email inv√°lido.'
            : error.code === 'auth/user-not-found' 
              ? 'Email n√£o registrado.'
              : 'Erro ao enviar email de redefini√ß√£o. Tente novamente.';
        });
    });

    document.getElementById('menuBtn').addEventListener('click', () => {
      document.getElementById('menuLateral').classList.toggle('sidebar-hidden');
      document.getElementById('menuLateral').classList.toggle('sidebar-visible');
    });

    document.getElementById('fecharMenu').addEventListener('click', () => {
      document.getElementById('menuLateral').classList.add('sidebar-hidden');
      document.getElementById('menuLateral').classList.remove('sidebar-visible');
    });

    document.getElementById('btnSair').addEventListener('click', () => {
      auth.signOut()
        .then(() => {
          usuarioLogado = null;
          isAdmin = false;
          isSuperAdmin = false;
          salaAtual = null;
          mostrarTela('inicio');
        })
        .catch((error) => {
          console.error('Erro ao deslogar:', error);
          alert('Erro ao sair. Tente novamente.');
        });
    });

    document.getElementById('btnContinuar').addEventListener('click', async () => {
      if (isAdmin) await gerarEscala();
    });

    document.getElementById('formQuemLimpou').addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!salaAtual) return;

      const checkboxes = document.querySelectorAll('#checkboxContainer input[name="faltante"]:checked');
      if (checkboxes.length === 0) {
        await salvarEscalaNoFirestore();
        atualizarResultadoEFormulario();
        return;
      }

      salaAtual.faltantesPendentes = [];
      checkboxes.forEach(cb => {
        const nome = cb.value;
        const pessoa = salaAtual.escalaAtual.find(p => p.nome === nome);
        if (pessoa) salaAtual.faltantesPendentes.push({ nome, tarefa: pessoa.tarefa });
        cb.checked = false;
      });

      salaAtual.escalaAtual = salaAtual.escalaAtual.filter(p => !salaAtual.faltantesPendentes.some(f => f.nome === p.nome));
      let usados = salaAtual.escalaAtual.map(p => p.nome).concat(salaAtual.faltantesPendentes.map(f => f.nome));
      let idx = salaAtual.posicaoUltimaEscala;

      for (let faltante of salaAtual.faltantesPendentes) {
        if (salaAtual.escalaAtual.length >= 2) break;
        idx = proximoIndice(idx, usados);
        if (idx === -1) break;
        const nome = salaAtual.nomes[idx];
        const tarefa = faltante.tarefa;
        salaAtual.escalaAtual.push({ nome, tarefa, index: idx });
        salaAtual.historicoTarefa[nome] = tarefa;
        usados.push(nome);
        salaAtual.posicaoUltimaEscala = idx;
      }

      while (salaAtual.escalaAtual.length < 2 && salaAtual.nomes.length > usados.length) {
        idx = proximoIndice(idx, usados);
        if (idx === -1) break;
        const nome = salaAtual.nomes[idx];
        const tarefa = salaAtual.escalaAtual[0].tarefa === 'mesa' ? 'ch√£o' : 'mesa';
        salaAtual.escalaAtual.push({ nome, tarefa, index: idx });
        salaAtual.historicoTarefa[nome] = tarefa;
        usados.push(nome);
        salaAtual.posicaoUltimaEscala = idx;
      }

      await salvarEscalaNoFirestore();
      atualizarResultadoEFormulario();
    });

    // Fun√ß√µes de edi√ß√£o de nomes
    document.getElementById('btnEditarNomes').addEventListener('click', () => {
      mostrarTela('editar-nomes');
    });

    document.getElementById('btnVoltarEdicao').addEventListener('click', () => {
      mostrarTela('painel');
    });

    function atualizarListaNomesEdicao() {
      if (!salaAtual) return;
      const ul = document.getElementById('listaNomesEdicao');
      ul.innerHTML = '';
      salaAtual.nomes.forEach((nome, idx) => {
        const li = document.createElement('li');
        li.className = 'flex justify-between items-center p-3 border-b border-gray-200';
        li.textContent = nome;
        const btnRemover = document.createElement('button');
        btnRemover.textContent = 'Remover';
        btnRemover.className = 'bg-red-600 text-white px-4 py-1 rounded-lg hover:bg-red-700 transition';
        btnRemover.addEventListener('click', async () => {
          const pessoaNaEscala = salaAtual.escalaAtual.find(p => p.nome === nome);
          salaAtual.nomes.splice(idx, 1);
          salaAtual.escalaAtual = salaAtual.escalaAtual.filter(p => p.nome !== nome);
          salaAtual.faltantesPendentes = salaAtual.faltantesPendentes.filter(f => f.nome !== nome);
          if (pessoaNaEscala && salaAtual.nomes.length > 0) {
            substituirPessoaNaEscala(nome, pessoaNaEscala.tarefa);
          }
          await salvarConfigNoFirestore();
          await salvarEscalaNoFirestore();
          atualizarListaNomesEdicao();
          atualizarResultadoEFormulario();
        });
        li.appendChild(btnRemover);
        ul.appendChild(li);
      });
    }

    document.getElementById('btnAdicionarNome').addEventListener('click', async () => {
      if (!salaAtual) return;
      const input = document.getElementById('novoNomeInput');
      const novoNome = input.value.trim();
      if (novoNome.length > 0 && !salaAtual.nomes.some(n => n.toLowerCase() === novoNome.toLowerCase())) {
        salaAtual.nomes.push(novoNome);
        salaAtual.nomes.sort((a, b) => a.localeCompare(b));
        adicionarPessoaNaEscala(novoNome);
        input.value = '';
        await salvarConfigNoFirestore();
        await salvarEscalaNoFirestore();
        atualizarListaNomesEdicao();
        atualizarResultadoEFormulario();
      } else {
        alert('Nome inv√°lido ou j√° existe!');
      }
    });

    document.getElementById('btnZerarNomes').addEventListener('click', async () => {
      if (!salaAtual) return;
      if (confirm('Tem certeza que quer apagar todos os nomes?')) {
        salaAtual.nomes = [];
        salaAtual.escalaAtual = [];
        salaAtual.faltantesPendentes = [];
        await salvarConfigNoFirestore();
        await salvarEscalaNoFirestore();
        atualizarListaNomesEdicao();
        mostrarTela('painel');
        alert('Lista de nomes zerada com sucesso!');
      }
    });

    // Fun√ß√µes de gerenciamento de administradores
    document.getElementById('btnLiberarAcesso').addEventListener('click', () => {
      if (isAdmin) mostrarTela('gerenciar-admins');
    });

    document.getElementById('btnVoltarAdmins').addEventListener('click', () => {
      mostrarTela('painel');
    });

    function atualizarListaAdminsEdicao() {
      if (!salaAtual) return;
      const ul = document.getElementById('listaAdminsEdicao');
      ul.innerHTML = '';
      salaAtual.admins.forEach((email, idx) => {
        const li = document.createElement('li');
        li.className = 'flex justify-between items-center p-3 border-b border-gray-200';
        li.textContent = email;
        const btnRemover = document.createElement('button');
        btnRemover.textContent = 'Remover';
        btnRemover.className = 'bg-red-600 text-white px-4 py-1 rounded-lg hover:bg-red-700 transition';
        btnRemover.addEventListener('click', () => {
          if (salaAtual.admins.length <= 1) {
            alert('N√£o √© poss√≠vel remover o √∫ltimo administrador!');
            return;
          }
          if (usuarioLogado.email === email) {
            alert('Voc√™ n√£o pode remover seu pr√≥prio email!');
            return;
          }
          salaAtual.admins.splice(idx, 1);
          atualizarListaAdminsEdicao();
          salvarConfigNoFirestore();
        });
        li.appendChild(btnRemover);
        ul.appendChild(li);
      });
    }

    document.getElementById('btnAdicionarAdmin').addEventListener('click', () => {
      if (!salaAtual) return;
      const inputEmail = document.getElementById('novoAdminInput');
      const inputSenha = document.getElementById('novaSenhaAdminInput');
      const novoEmail = inputEmail.value.trim();
      const novaSenha = inputSenha.value.trim();
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

      if (!novoEmail || !emailRegex.test(novoEmail)) {
        alert('Digite um email v√°lido!');
        return;
      }
      if (salaAtual.admins.includes(novoEmail)) {
        alert('Este email j√° est√° na lista de administradores!');
        return;
      }
      if (novaSenha.length < 6) {
        alert('A senha deve ter pelo menos 6 caracteres!');
        return;
      }

      auth.fetchSignInMethodsForEmail(novoEmail)
        .then((signInMethods) => {
          if (signInMethods.length > 0) {
            salaAtual.admins.push(novoEmail);
            salaAtual.admins.sort((a, b) => a.localeCompare(b));
            adminConfig[novoEmail] = { primeiroLogin: true };
            inputEmail.value = '';
            inputSenha.value = '';
            atualizarListaAdminsEdicao();
            salvarConfigNoFirestore();
          } else {
            auth.createUserWithEmailAndPassword(novoEmail, novaSenha)
              .then((userCredential) => {
                salaAtual.admins.push(novoEmail);
                salaAtual.admins.sort((a, b) => a.localeCompare(b));
                adminConfig[novoEmail] = { primeiroLogin: true };
                inputEmail.value = '';
                inputSenha.value = '';
                atualizarListaAdminsEdicao();
                salvarConfigNoFirestore();
                userCredential.user.sendEmailVerification();
              })
              .catch((error) => {
                console.error('Erro ao criar usu√°rio:', error);
                alert(error.code === 'auth/email-already-in-use' 
                  ? 'Este email j√° est√° registrado.'
                  : error.code === 'auth/invalid-email' 
                    ? 'Email inv√°lido.'
                    : 'Erro ao criar usu√°rio. Tente novamente.');
              });
          }
        })
        .catch((error) => {
          console.error('Erro ao verificar email:', error);
          alert('Erro ao verificar o email. Verifique se √© v√°lido.');
        });
    });

    document.getElementById('btnSalvarAdmins').addEventListener('click', async () => {
      if (!salaAtual) return;
      await salvarConfigNoFirestore();
      alert('Lista de administradores salva com sucesso!');
      mostrarTela('painel');
    });

    // Fun√ß√µes de Minha Conta
    document.getElementById('btnMinhaConta').addEventListener('click', () => {
      if (isAdmin) mostrarTela('minha-conta');
    });

    document.getElementById('btnVoltarMinhaConta').addEventListener('click', () => {
      mostrarTela('painel');
    });

    function atualizarTelaMinhaConta() {
      const mensagemAviso = document.getElementById('mensagemAviso');
      const mensagemErro = document.getElementById('mensagemErroMinhaConta');
      mensagemErro.textContent = '';
      document.getElementById('novaSenhaInput').value = '';
      document.getElementById('confirmarSenhaInput').value = '';
      mensagemAviso.textContent = adminConfig[usuarioLogado.email]?.primeiroLogin 
        ? 'Bem-vindo! Por favor, defina uma nova senha para sua conta.'
        : '';
    }

    document.getElementById('btnAlterarSenha').addEventListener('click', () => {
      const novaSenha = document.getElementById('novaSenhaInput').value.trim();
      const confirmarSenha = document.getElementById('confirmarSenhaInput').value.trim();
      const mensagemErro = document.getElementById('mensagemErroMinhaConta');

      if (!novaSenha || !confirmarSenha) {
        mensagemErro.textContent = 'Preencha ambos os campos de senha!';
        return;
      }
      if (novaSenha !== confirmarSenha) {
        mensagemErro.textContent = 'As senhas n√£o coincidem!';
        return;
      }
      if (novaSenha.length < 6) {
        mensagemErro.textContent = 'A senha deve ter pelo menos 6 caracteres!';
        return;
      }

      const user = auth.currentUser;
      if (user) {
        user.updatePassword(novaSenha)
          .then(() => {
            adminConfig[usuarioLogado.email] = { primeiroLogin: false };
            salvarConfigNoFirestore()
              .then(() => {
                alert('Senha alterada com sucesso!');
                mostrarTela('painel');
              })
              .catch((error) => {
                console.error('Erro ao salvar config:', error);
                mensagemErro.textContent = 'Erro ao salvar altera√ß√µes. Tente novamente.';
              });
          })
          .catch((error) => {
            console.error('Erro ao alterar senha:', error);
            mensagemErro.textContent = error.code === 'auth/requires-recent-login' 
              ? 'Fa√ßa login novamente para alterar a senha.'
              : 'Erro ao alterar senha. Tente novamente.';
            if (error.code === 'auth/requires-recent-login') auth.signOut().then(() => mostrarTela('login'));
          });
      } else {
        mensagemErro.textContent = 'Usu√°rio n√£o autenticado. Fa√ßa login novamente.';
        auth.signOut().then(() => mostrarTela('login'));
      }
    });

    // Fun√ß√µes de cria√ß√£o de salas
    document.getElementById('btnCriarSala').addEventListener('click', async () => {
      if (!isSuperAdmin) {
        alert('Apenas o super administrador pode criar novas salas.');
        return;
      }
      const nomeSala = prompt('Digite o nome da nova sala:');
      if (nomeSala && nomeSala.trim()) {
        const salaId = db.collection('salas').doc().id;
        const novaSala = {
          id: salaId,
          nome: nomeSala.trim(),
          admins: ['nicolasgmbatista15@gmail.com'],
          nomes: [],
          adminConfig: {},
          posicaoUltimaEscala: -1,
          historicoTarefa: {},
          escalaAtual: [],
          faltantesPendentes: []
        };
        await db.collection('salas').doc(salaId).set({ nome: novaSala.nome, admins: novaSala.admins });
        await db.collection('salas').doc(salaId).collection('config').doc('dados').set({
          nomes: [],
          admins: ['nicolasgmbatista15@gmail.com'],
          adminConfig: {}
        });
        await db.collection('salas').doc(salaId).collection('escala').doc('dados').set({
          posicaoUltimaEscala: -1,
          historicoTarefa: {},
          escalaAtual: [],
          faltantesPendentes: []
        });
        salas.push(novaSala);
        atualizarListaSalas();
      }
    });

    // Fun√ß√µes de laborat√≥rio
    document.getElementById('btnConfigLaboratorio').addEventListener('click', async () => {
      if (!salaAtual) return;
      document.getElementById('modalLaboratorio').classList.remove('modal-hidden');
      document.getElementById('modalLaboratorio').classList.add('modal-visible');
      const hoje = new Date().toISOString().split('T')[0];
      const grupos = await carregarLaboratorio(hoje);
      document.getElementById('qtdGrupos').value = grupos.length || 1;
      atualizarGruposLaboratorio(grupos.length || 1);
      grupos.forEach((g, i) => {
        document.getElementById(`funcoesGrupo${i + 1}`).value = g.funcoes.join(', ');
      });
    });

    document.getElementById('qtdGrupos').addEventListener('change', (e) => {
      atualizarGruposLaboratorio(parseInt(e.target.value));
    });

    document.getElementById('btnSalvarLaboratorio').addEventListener('click', async () => {
      if (!salaAtual) return;
      const qtdGrupos = parseInt(document.getElementById('qtdGrupos').value);
      const grupos = [];
      for (let i = 1; i <= qtdGrupos; i++) {
        const funcoes = document.getElementById(`funcoesGrupo${i}`).value.split(',').map(f => f.trim()).filter(f => f);
        grupos.push({ id: i, funcoes });
      }
      const hoje = new Date().toISOString().split('T')[0];
      await salvarLaboratorio(hoje, grupos);
      document.getElementById('modalLaboratorio').classList.add('modal-hidden');
      document.getElementById('modalLaboratorio').classList.remove('modal-visible');
      alert('Configura√ß√£o de laborat√≥rio salva com sucesso!');
    });

    document.getElementById('btnCancelarLaboratorio').addEventListener('click', () => {
      document.getElementById('modalLaboratorio').classList.add('modal-hidden');
      document.getElementById('modalLaboratorio').classList.remove('modal-visible');
    });

    // Tema claro/escuro
    document.getElementById('themeToggle').addEventListener('click', () => {
      const body = document.body;
      const isDark = body.getAttribute('data-theme') === 'dark';
      body.setAttribute('data-theme', isDark ? 'light' : 'dark');
      document.getElementById('themeToggle').textContent = isDark ? 'üåô' : '‚òÄÔ∏è';
    });

    // Inicializa app
    carregarSalas().then(() => {
      if (usuarioLogado) {
        mostrarTela('inicio');
      } else {
        mostrarTela('inicio');
      }
    });
  </script>
</body>
</html>
