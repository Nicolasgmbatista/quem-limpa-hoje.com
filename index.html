<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Quem limpa a sala hoje?</title>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #f0f2f5;
      color: #2c3e50;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
    }

    #app {
      width: 420px;
      background: #fff;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
      text-align: center;
      position: relative;
      border: 1px solid #e0e0e0;
    }

    h1 {
      margin-bottom: 20px;
      font-weight: 600;
      font-size: 24px;
      color: #2c3e50;
    }

    h2 {
      font-size: 20px;
      margin-bottom: 16px;
      color: #2c3e50;
    }

    button, input {
      font-size: 16px;
      border-radius: 8px;
      border: none;
      padding: 12px;
      margin: 8px 0;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s ease;
      outline: none;
    }

    button {
      background-color: #2c3e50;
      color: white;
    }

    button:hover {
      background-color: #34495e;
    }

    input[type="email"], input[type="password"], input[type="text"] {
      width: 100%;
      max-width: 300px;
      border: 2px solid #dcdcdc;
      transition: border-color 0.3s ease;
      padding: 12px;
      box-sizing: border-box;
    }

    input[type="email"]:focus, input[type="password"]:focus, input[type="text"]:focus {
      border-color: #2c3e50;
    }

    #menuBtn {
      position: absolute;
      top: 20px;
      right: 20px;
      background: transparent;
      font-size: 28px;
      color: #2c3e50;
      border: none;
      cursor: pointer;
      padding: 0;
    }

    #menuLateral {
      position: fixed;
      top: 0;
      right: -300px;
      width: 300px;
      height: 100vh;
      background: #2c3e50;
      color: white;
      padding: 20px;
      display: none;
      flex-direction: column;
      gap: 15px;
      box-shadow: -5px 0 10px rgba(0,0,0,0.2);
      z-index: 1000;
      transition: right 0.3s ease;
    }

    #menuLateral.aberto {
      right: 0;
      display: flex;
    }

    #menuLateral button,
    #fecharMenu {
      background: #34495e;
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      font-size: 16px;
    }

    #menuLateral button:hover,
    #fecharMenu:hover {
      background: #3c5a7a;
    }

    #resultado h2 {
      margin-bottom: 12px;
      font-weight: 600;
    }

    #resultado ul {
      list-style: none;
      padding: 0;
      margin: 0 0 20px 0;
      text-align: left;
    }

    #resultado li {
      background: #f5f7fa;
      margin-bottom: 8px;
      padding: 12px;
      border-radius: 8px;
      color: #2c3e50;
      font-weight: 500;
      display: flex;
      justify-content: space-between;
    }

    #checkboxContainer {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: center;
      margin-top: 12px;
    }

    #checkboxContainer div {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    #formQuemLimpou {
      margin-top: 20px;
      max-width: 300px;
      margin-left: auto;
      margin-right: auto;
    }

    #formQuemLimpou button[type="submit"] {
      margin-top: 20px;
      width: 100%;
      max-width: 300px;
    }

    #btnReset {
      background-color: #c0392b;
    }

    #btnReset:hover {
      background-color: #e74c3c;
    }

    #mensagemErro, #mensagemErroMinhaConta {
      color: #c0392b;
      font-weight: 500;
      margin-bottom: 12px;
      font-size: 14px;
    }

    #mensagemAviso {
      color: #e67e22;
      font-weight: 500;
      margin-bottom: 12px;
      font-size: 14px;
    }

    #btnContinuar {
      margin-top: 12px;
      background-color: #27ae60;
      width: 100%;
      max-width: 300px;
      margin-left: auto;
      margin-right: auto;
    }

    #btnContinuar:hover {
      background-color: #2ecc71;
    }

    #telaInicial button {
      width: 100%;
      max-width: 200px;
    }

    #checkboxContainer div label {
      font-size: 16px;
    }

    #avisoReset {
      margin-top: 20px;
      color: #e74c3c;
      font-weight: 500;
      font-size: 14px;
      text-align: center;
    }

    #telaLogin {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }

    #telaLogin input {
      width: 100%;
      max-width: 300px;
    }

    #botoesLogin {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      width: 100%;
      max-width: 300px;
    }

    #botoesLogin button {
      width: 48%;
      min-width: 120px;
    }

    #btnEsqueciSenha {
      background: transparent;
      color: #2c3e50;
      text-decoration: underline;
      font-size: 14px;
      padding: 5px;
      margin-top: 5px;
      width: auto;
    }

    #btnEsqueciSenha:hover {
      color: #34495e;
    }

    #telaEditarNomes, #telaGerenciarAdmins, #telaMinhaConta {
      display: none;
      flex-direction: column;
      align-items: center;
      max-width: 360px;
      margin: 0 auto;
    }

    #listaNomesEdicao, #listaAdminsEdicao {
      list-style: none;
      padding: 0;
      width: 100%;
      max-height: 300px;
      overflow-y: auto;
      margin-bottom: 16px;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      background: #f9fafb;
    }

    #listaNomesEdicao li, #listaAdminsEdicao li {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      border-bottom: 1px solid #e0e0e0;
      font-weight: 500;
      color: #2c3e50;
      word-break: break-word;
    }

    #listaNomesEdicao li:last-child, #listaAdminsEdicao li:last-child {
      border-bottom: none;
    }

    #listaAdminsEdicao button.removerAdminBtn {
      background-color: #c0392b;
      padding: 6px 10px;
      font-size: 13px;
      border-radius: 6px;
      min-width: 60px;
      width: 60px;
      text-align: center;
      line-height: 1.2;
    }

    #listaNomesEdicao button.removerNomeBtn {
      background-color: #c0392b;
      padding: 6px 10px;
      font-size: 13px;
      border-radius: 6px;
      min-width: 80px;
      width: 80px;
      text-align: center;
      line-height: 1.2;
      white-space: nowrap;
    }

    #listaNomesEdicao button.removerNomeBtn:hover, #listaAdminsEdicao button.removerAdminBtn:hover {
      background-color: #e74c3c;
    }

    #novoNomeContainer, #novoAdminContainer, #alterarSenhaContainer {
      display: flex;
      flex-direction: column;
      gap: 10px;
      width: 100%;
      max-width: 300px;
      margin-bottom: 16px;
    }

    #novoNomeInput, #novoAdminInput, #novaSenhaAdminInput, #novaSenhaInput, #confirmarSenhaInput {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      border-radius: 8px;
      border: 2px solid #dcdcdc;
    }

    #novoNomeContainer button, #novoAdminContainer button {
      width: 100%;
      max-width: 300px;
    }

    #telaEditarNomes button, #telaGerenciarAdmins button, #telaMinhaConta button {
      width: 100%;
      max-width: 300px;
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- Telas iniciais e login -->
    <div id="telaInicial">
      <h1>Quem limpa a sala hoje?</h1>
      <p>Escolha seu perfil para continuar:</p>
      <button id="btnProfessor">Professor / Representante</button>
      <button id="btnEstudante">Estudante</button>
    </div>

    <div id="telaLogin" style="display:none;">
      <h1>Login - Professor / Representante</h1>
      <div id="mensagemErro"></div>
      <input type="email" id="emailLogin" placeholder="Email" autocomplete="username" />
      <input type="password" id="senhaLogin" placeholder="Senha" autocomplete="current-password" />
      <div id="botoesLogin">
        <button id="btnEntrar">Entrar</button>
        <button id="btnVoltarLogin">Voltar</button>
      </div>
      <button id="btnEsqueciSenha">Esqueci minha senha</button>
    </div>

    <!-- Tela principal da escala -->
    <div id="conteudoEscala" style="display:none;">
      <button id="menuBtn" title="Abrir menu">☰</button>
      <h1>Quem limpa a sala hoje?</h1>
      <div id="resultado">
        <h2>Escala de hoje:</h2>
        <ul id="listaEscala"></ul>
        <button id="btnContinuar">Continuar</button>
      </div>
      <div id="pergunta" style="display:none;">
        <p>Selecione quem <strong>faltou</strong> ou <strong>limpou o laboratório</strong> e clique em "CONFIRMAR" para atualizar:</p>
        <form id="formQuemLimpou">
          <div id="checkboxContainer"></div>
          <button type="submit">Confirmar</button>
        </form>
      </div>
    </div>

    <!-- Menu lateral -->
    <nav id="menuLateral">
      <button id="fecharMenu" title="Voltar">Voltar</button>
      <button id="btnMinhaConta">Minha Conta</button>
      <button id="btnEditarNomes">Editar Nomes</button>
      <button id="btnLiberarAcesso">Liberar Acesso</button>
      <button id="btnResetar">Resetar Escala</button>
      <button id="btnSair">Sair</button>
    </nav>

    <!-- Tela para edição dos nomes -->
    <div id="telaEditarNomes">
      <h2>Editar Nomes</h2>
      <ul id="listaNomesEdicao"></ul>
      <div id="novoNomeContainer">
        <input type="text" id="novoNomeInput" placeholder="Digite novo nome" />
        <button id="btnAdicionarNome">Adicionar</button>
      </div>
      <button id="btnZerarNomes">Zerar</button>
      <button id="btnVoltarEdicao">Voltar</button>
    </div>

    <!-- Tela para gerenciar administradores -->
    <div id="telaGerenciarAdmins">
      <h2>Gerenciar Administradores</h2>
      <ul id="listaAdminsEdicao"></ul>
      <div id="novoAdminContainer">
        <input type="email" id="novoAdminInput" placeholder="Digite novo email" />
        <input type="password" id="novaSenhaAdminInput" placeholder="Senha inicial" />
        <button id="btnAdicionarAdmin">Adicionar</button>
      </div>
      <button id="btnSalvarAdmins">Salvar</button>
      <button id="btnVoltarAdmins">Voltar</button>
    </div>

    <!-- Tela para minha conta -->
    <div id="telaMinhaConta">
      <h2>Minha Conta</h2>
      <div id="mensagemAviso"></div>
      <div id="mensagemErroMinhaConta"></div>
      <div id="alterarSenhaContainer">
        <input type="password" id="novaSenhaInput" placeholder="Nova senha" />
        <input type="password" id="confirmarSenhaInput" placeholder="Confirmar nova senha" />
        <button id="btnAlterarSenha">Alterar Senha</button>
      </div>
      <button id="btnVoltarMinhaConta">Voltar</button>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  
  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyAGkdnFfJNw4r6yYpSGIpgjwISBOppwR60",
      authDomain: "quem-limpa-hoje.firebaseapp.com",
      projectId: "quem-limpa-hoje",
      storageBucket: "quem-limpa-hoje.firebasestorage.app",
      messagingSenderId: "44929275404",
      appId: "1:44929275404:web:971258e864925cb3684029"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // Variáveis globais
    let admins = [
      "gonzagamezzomozaira@gmail.com",
      "fabiana.martini@edu.sc.senai.br",
      "beatriz_k_morais@estudante.sesisenai.org.br",
      "nicolasgmbatista15@gmail.com",
      "cassia.savi@edu.sc.senai.br"
    ];
    let nomes = ["Ana", "Beatriz", "Bernardo", "Emanuelly", "Gabriel", "Gabrielle", "Greicy", "Henzo", "Igor", "Isadora", "Jennifer", "Joedna", "Kemilly Silva", "Kemilly Puff", "Luiz", "Mateus Yuri", "Mateus Chagas", "Nayara", "Nicolas", "Norehangeles", "Pedro", "Samuel", "Sebastião", "Zaira"].sort((a, b) => a.localeCompare(b));
    let posicaoUltimaEscala = -1;
    let historicoTarefa = {};
    let escalaAtual = [];
    let faltantesPendentes = [];
    let usuarioLogado = null;
    let isAdmin = false;
    let telaAtual = 'inicio';
    let adminConfig = {};

    // Funções para mostrar/ocultar telas
    function mostrarTela(t) {
      telaAtual = t;
      document.getElementById('telaInicial').style.display = 'none';
      document.getElementById('telaLogin').style.display = 'none';
      document.getElementById('conteudoEscala').style.display = 'none';
      document.getElementById('telaEditarNomes').style.display = 'none';
      document.getElementById('telaGerenciarAdmins').style.display = 'none';
      document.getElementById('telaMinhaConta').style.display = 'none';
      document.getElementById('menuBtn').style.display = 'none';
      document.getElementById('menuLateral').classList.remove('aberto');
      document.getElementById('menuLateral').style.display = 'none';
      document.getElementById('btnContinuar').style.display = 'none';
      document.getElementById('pergunta').style.display = 'none';

      switch (t) {
        case 'inicio':
          document.getElementById('telaInicial').style.display = 'block';
          break;
        case 'login':
          document.getElementById('telaLogin').style.display = 'flex';
          document.getElementById('emailLogin').value = '';
          document.getElementById('senhaLogin').value = '';
          document.getElementById('mensagemErro').textContent = '';
          break;
        case 'painel':
          document.getElementById('conteudoEscala').style.display = 'block';
          document.getElementById('menuBtn').style.display = isAdmin ? 'block' : 'none';
          document.getElementById('menuLateral').style.display = isAdmin ? 'none' : 'none';
          document.getElementById('btnContinuar').style.display = isAdmin ? 'block' : 'none';
          document.getElementById('pergunta').style.display = isAdmin ? 'block' : 'none';
          atualizarResultadoEFormulario();
          if (isAdmin) montarCheckboxFaltantes();
          break;
        case 'editar-nomes':
          document.getElementById('telaEditarNomes').style.display = 'flex';
          atualizarListaNomesEdicao();
          break;
        case 'gerenciar-admins':
          document.getElementById('telaGerenciarAdmins').style.display = 'flex';
          atualizarListaAdminsEdicao();
          break;
        case 'minha-conta':
          document.getElementById('telaMinhaConta').style.display = 'flex';
          atualizarTelaMinhaConta();
          break;
      }
      console.log(`Tela atual: ${telaAtual}`);
    }

    // Inicializa app
    mostrarTela('inicio');

    // Funções de persistência
    async function salvarEscalaNoFirestore() {
      try {
        await db.collection('escala').doc('dados').set({
          posicaoUltimaEscala,
          historicoTarefa,
          escalaAtual,
          faltantesPendentes
        });
        console.log('Escala salva no Firestore:', { posicaoUltimaEscala, historicoTarefa, escalaAtual, faltantesPendentes });
      } catch (error) {
        console.error("Erro ao salvar no Firestore:", error);
        alert("Erro ao salvar a escala. Verifique sua conexão.");
      }
    }

    async function salvarConfigNoFirestore() {
      try {
        await db.collection('escala').doc('config').set({ nomes, admins, adminConfig }, { merge: true });
        console.log('Config salva no Firestore:', { nomes, admins, adminConfig });
      } catch (error) {
        console.error('Erro ao salvar config no Firestore:', error);
        alert('Erro ao salvar configurações. Verifique sua conexão.');
      }
    }

    async function lerEscalaDoFirestore() {
      try {
        const doc = await db.collection('escala').doc('dados').get();
        const configDoc = await db.collection('escala').doc('config').get();
        
        if (doc.exists) {
          const data = doc.data();
          posicaoUltimaEscala = data.posicaoUltimaEscala ?? -1;
          historicoTarefa = data.historicoTarefa ?? {};
          escalaAtual = data.escalaAtual ?? [];
          faltantesPendentes = data.faltantesPendentes ?? [];
          console.log('Escala carregada do Firestore:', { posicaoUltimaEscala, historicoTarefa, escalaAtual, faltantesPendentes });
        } else {
          console.log('Nenhum dado encontrado no Firestore, inicializando escala vazia');
          escalaAtual = [];
          posicaoUltimaEscala = -1;
          historicoTarefa = {};
          faltantesPendentes = [];
          await salvarEscalaNoFirestore();
        }

        if (configDoc.exists) {
          const configData = configDoc.data();
          nomes = configData.nomes ?? ["Ana", "Beatriz", "Bernardo", "Emanuelly", "Gabriel", "Gabrielle", "Greicy", "Henzo", "Igor", "Isadora", "Jennifer", "Joedna", "Kemilly Silva", "Kemilly Puff", "Luiz", "Mateus Yuri", "Mateus Chagas", "Nayara", "Nicolas", "Norehangeles", "Pedro", "Samuel", "Sebastião", "Zaira"].sort((a, b) => a.localeCompare(b));
          admins = configData.admins ?? [
            "gonzagamezzomozaira@gmail.com",
            "fabiana.martini@edu.sc.senai.br",
            "beatriz_k_morais@estudante.sesisenai.org.br",
            "nicolasgmbatista15@gmail.com",
            "cassia.savi@edu.sc.senai.br"
          ];
          adminConfig = configData.adminConfig ?? {};
          console.log('Config carregada do Firestore:', { nomes, admins, adminConfig });
        } else {
          console.log('Nenhuma config encontrada no Firestore, usando padrão');
        }
        atualizarResultadoEFormulario();
      } catch (error) {
        console.error("Erro ao carregar do Firestore:", error);
        alert("Erro ao carregar a escala. Usando valores padrão.");
      }
    }

    // Funções da escala
    function proximoIndice(atual, ignorados = []) {
      let i = atual;
      for (let c = 0; c < nomes.length; c++) {
        i = (i + 1) % nomes.length;
        if (!ignorados.includes(nomes[i])) return i;
      }
      console.log('Nenhum índice disponível para substituição');
      return -1;
    }

    async function gerarEscala() {
      if (nomes.length === 0) {
        escalaAtual = [];
        document.getElementById('listaEscala').innerHTML = '<li>Nenhum nome cadastrado.</li>';
        document.getElementById('pergunta').style.display = isAdmin ? 'block' : 'none';
        document.getElementById('btnContinuar').style.display = isAdmin ? 'block' : 'none';
        await salvarEscalaNoFirestore();
        console.log('Nenhum nome cadastrado, escala vazia');
        return;
      }

      console.log('Gerando nova escala, faltantes pendentes:', faltantesPendentes);
      escalaAtual = [...faltantesPendentes];
      let usados = escalaAtual.map(p => p.nome);
      let idx = posicaoUltimaEscala;

      while (escalaAtual.length < 2 && nomes.length > usados.length) {
        idx = proximoIndice(idx, usados);
        if (idx === -1) break;
        const nome = nomes[idx];
        const ultimaTarefa = historicoTarefa[nome];
        let tarefa = escalaAtual.length === 0 
          ? (ultimaTarefa === 'chão' ? 'mesa' : 'chão')
          : (escalaAtual[0].tarefa === 'mesa' ? 'chão' : 'mesa');
        escalaAtual.push({ nome, tarefa, index: idx });
        historicoTarefa[nome] = tarefa;
        usados.push(nome);
        posicaoUltimaEscala = idx;
        console.log(`Adicionado à escala: ${nome} - ${tarefa}`);
      }

      faltantesPendentes = [];
      await salvarEscalaNoFirestore();
      atualizarResultadoEFormulario();
    }

    function substituirPessoaNaEscala(nomeRemovido, tarefa) {
      if (nomes.length === 0) {
        escalaAtual = [];
        faltantesPendentes = faltantesPendentes.filter(f => f.nome !== nomeRemovido);
        return;
      }

      let usados = escalaAtual.map(p => p.nome).concat(faltantesPendentes.map(f => f.nome));
      let idx = posicaoUltimaEscala;
      idx = proximoIndice(idx, usados);
      if (idx === -1) {
        console.log('Nenhum substituto disponível para', nomeRemovido);
        escalaAtual = escalaAtual.filter(p => p.nome !== nomeRemovido);
        faltantesPendentes = faltantesPendentes.filter(f => f.nome !== nomeRemovido);
        return;
      }

      const novoNome = nomes[idx];
      escalaAtual = escalaAtual.filter(p => p.nome !== nomeRemovido);
      escalaAtual.push({ nome: novoNome, tarefa, index: idx });
      historicoTarefa[novoNome] = tarefa;
      posicaoUltimaEscala = idx;
      faltantesPendentes = faltantesPendentes.filter(f => f.nome !== nomeRemovido);
      console.log(`Substituído ${nomeRemovido} por ${novoNome} - ${tarefa}`);
    }

    function adicionarPessoaNaEscala(novoNome) {
      if (nomes.length === 0) {
        return;
      }

      let usados = escalaAtual.map(p => p.nome).concat(faltantesPendentes.map(f => f.nome));
      if (usados.includes(novoNome)) {
        return;
      }

      const idxNovoNome = nomes.indexOf(novoNome);
      if (idxNovoNome === -1) {
        return;
      }

      if (escalaAtual.length === 0) {
        const tarefa = historicoTarefa[novoNome] === 'chão' ? 'mesa' : 'chão';
        escalaAtual.push({ nome: novoNome, tarefa, index: idxNovoNome });
        historicoTarefa[novoNome] = tarefa;
        posicaoUltimaEscala = idxNovoNome;
        console.log(`Adicionado ${novoNome} à escala (escala vazia) - ${tarefa}`);
        return;
      }

      if (escalaAtual.length === 1) {
        const tarefa = escalaAtual[0].tarefa === 'mesa' ? 'chão' : 'mesa';
        escalaAtual.push({ nome: novoNome, tarefa, index: idxNovoNome });
        historicoTarefa[novoNome] = tarefa;
        posicaoUltimaEscala = idxNovoNome;
        console.log(`Adicionado ${novoNome} à escala (1 pessoa) - ${tarefa}`);
        return;
      }

      const idxPrimeiro = escalaAtual[0].index;
      const proximaPessoaIdx = proximoIndice(idxPrimeiro, usados);
      if (proximaPessoaIdx === idxNovoNome) {
        const tarefa = escalaAtual[1].tarefa;
        escalaAtual = [escalaAtual[0], { nome: novoNome, tarefa, index: idxNovoNome }];
        historicoTarefa[novoNome] = tarefa;
        posicaoUltimaEscala = idxNovoNome;
        console.log(`Substituído ${escalaAtual[1].nome} por ${novoNome} - ${tarefa}`);
      }
    }

    function atualizarResultadoEFormulario() {
      const listaEscala = document.getElementById('listaEscala');
      listaEscala.innerHTML = '';
      if (escalaAtual.length === 0) {
        listaEscala.innerHTML = '<li>Nenhuma escala disponível.</li>';
        document.getElementById('pergunta').style.display = isAdmin ? 'block' : 'none';
        document.getElementById('btnContinuar').style.display = isAdmin ? 'block' : 'none';
      } else {
        escalaAtual.forEach(p => {
          const li = document.createElement('li');
          li.textContent = `${p.nome} - ${p.tarefa}`;
          listaEscala.appendChild(li);
        });
        document.getElementById('pergunta').style.display = isAdmin ? 'block' : 'none';
        document.getElementById('btnContinuar').style.display = isAdmin ? 'block' : 'none';
        if (isAdmin) montarCheckboxFaltantes();
      }
      console.log('Interface atualizada, escala atual:', escalaAtual, 'Faltantes pendentes:', faltantesPendentes);
    }

    function montarCheckboxFaltantes() {
      const container = document.getElementById('checkboxContainer');
      container.innerHTML = '';
      escalaAtual.forEach(p => {
        const div = document.createElement('div');
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = `chk_${p.nome.replace(/\s+/g, '_')}`;
        checkbox.value = p.nome;
        checkbox.name = 'faltante';
        const label = document.createElement('label');
        label.htmlFor = checkbox.id;
        label.textContent = p.nome;
        div.appendChild(checkbox);
        div.appendChild(label);
        container.appendChild(div);
      });
      console.log('Checkboxes montados para:', escalaAtual.map(p => p.nome));
    }

    // Funções de autenticação
    document.getElementById('btnProfessor').addEventListener('click', function() {
      mostrarTela('login');
    });

    document.getElementById('btnEstudante').addEventListener('click', function() {
      usuarioLogado = { email: null, tipo: 'estudante' };
      isAdmin = false;
      mostrarTela('painel');
    });

    document.getElementById('btnResetar').addEventListener('click', async function() {
      const confirmacao = confirm("Tem certeza que deseja resetar completamente a escala?");
      if (!confirmacao) return;

      posicaoUltimaEscala = -1;
      historicoTarefa = {};
      escalaAtual = [];
      faltantesPendentes = [];

      await salvarEscalaNoFirestore();
      atualizarResultadoEFormulario();
      alert("Escala resetada com sucesso!");
    });

    document.getElementById('btnEntrar').addEventListener('click', function() {
      const email = document.getElementById('emailLogin').value.trim();
      const senha = document.getElementById('senhaLogin').value.trim();
      const mensagemErro = document.getElementById('mensagemErro');

      if (email.length === 0 || senha.length === 0) {
        mensagemErro.textContent = 'Preencha email e senha!';
        return;
      }

      auth.signInWithEmailAndPassword(email, senha)
        .then((userCredential) => {
          const user = userCredential.user;
          if (admins.includes(user.email)) {
            usuarioLogado = { email: user.email, tipo: 'admin' };
            isAdmin = true;
            mensagemErro.textContent = '';
            if (adminConfig[user.email]?.primeiroLogin) {
              mostrarTela('minha-conta');
            } else {
              mostrarTela('painel');
            }
          } else {
            mensagemErro.textContent = 'Usuário não autorizado.';
            auth.signOut();
          }
        })
        .catch((error) => {
          console.error('Erro de autenticação:', error);
          if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
            mensagemErro.textContent = 'Email ou senha incorretos.';
          } else if (error.code === 'auth/invalid-email') {
            mensagemErro.textContent = 'Email inválido.';
          } else {
            mensagemErro.textContent = 'Erro ao fazer login. Tente novamente.';
          }
        });
    });

    document.getElementById('btnVoltarLogin').addEventListener('click', function() {
      mostrarTela('inicio');
    });

    document.getElementById('btnEsqueciSenha').addEventListener('click', function() {
      const email = document.getElementById('emailLogin').value.trim();
      const mensagemErro = document.getElementById('mensagemErro');

      if (!email) {
        mensagemErro.textContent = 'Digite seu email para redefinir a senha!';
        return;
      }

      auth.sendPasswordResetEmail(email)
        .then(() => {
          mensagemErro.textContent = 'Email de redefinição de senha enviado! Verifique sua caixa de entrada ou pasta de spam.';
        })
        .catch((error) => {
          console.error('Erro ao enviar email de redefinição:', error);
          if (error.code === 'auth/invalid-email') {
            mensagemErro.textContent = 'Email inválido.';
          } else if (error.code === 'auth/user-not-found') {
            mensagemErro.textContent = 'Email não registrado.';
          } else {
            mensagemErro.textContent = 'Erro ao enviar email de redefinição. Tente novamente.';
          }
        });
    });

    const menuBtn = document.getElementById('menuBtn');
    const menuLateral = document.getElementById('menuLateral');
    const fecharMenu = document.getElementById('fecharMenu');

    menuBtn.addEventListener('click', function() {
      menuLateral.style.display = 'flex';
      menuLateral.classList.toggle('aberto');
    });

    fecharMenu.addEventListener('click', function() {
      menuLateral.classList.remove('aberto');
      setTimeout(() => {
        menuLateral.style.display = 'none';
      }, 300);
    });

    document.getElementById('btnSair').addEventListener('click', function() {
      auth.signOut()
        .then(() => {
          usuarioLogado = null;
          isAdmin = false;
          mostrarTela('inicio');
          console.log('Usuário deslogado com sucesso');
        })
        .catch((error) => {
          console.error('Erro ao deslogar:', error);
          alert('Erro ao sair. Tente novamente.');
        });
    });

    document.getElementById('btnContinuar').addEventListener('click', async function() {
      if (isAdmin) {
        console.log('Botão Continuar clicado, gerando nova escala');
        await gerarEscala();
      }
    });

    document.getElementById('formQuemLimpou').addEventListener('submit', async function(e) {
      e.preventDefault();
      console.log('Evento submit disparado em formQuemLimpou');

      const checkboxes = document.querySelectorAll('#checkboxContainer input[name="faltante"]:checked');
      console.log('Checkboxes marcados:', checkboxes.length, Array.from(checkboxes).map(cb => cb.value));

      if (checkboxes.length === 0) {
        console.log('Nenhum faltante selecionado, mantendo escala atual');
        await salvarEscalaNoFirestore();
        atualizarResultadoEFormulario();
        return;
      }

      const escalaAntes = [...escalaAtual];
      faltantesPendentes = [];
      checkboxes.forEach(cb => {
        const nome = cb.value;
        const pessoa = escalaAtual.find(p => p.nome === nome);
        if (pessoa) {
          faltantesPendentes.push({ nome, tarefa: pessoa.tarefa });
          console.log(`Faltante adicionado: ${nome} - ${pessoa.tarefa}`);
        }
        cb.checked = false;
      });

      escalaAtual = escalaAtual.filter(p => !faltantesPendentes.some(f => f.nome === p.nome));
      console.log('Escala após remover faltantes:', escalaAtual);

      let usados = escalaAtual.map(p => p.nome).concat(faltantesPendentes.map(f => f.nome));
      let idx = posicaoUltimaEscala;

      for (let faltante of faltantesPendentes) {
        if (escalaAtual.length >= 2) break;
        idx = proximoIndice(idx, usados);
        if (idx === -1) {
          console.log('Nenhum substituto disponível para', faltante.nome);
          break;
        }
        const nome = nomes[idx];
        const tarefa = faltante.tarefa;
        escalaAtual.push({ nome, tarefa, index: idx });
        historicoTarefa[nome] = tarefa;
        usados.push(nome);
        posicaoUltimaEscala = idx;
        console.log(`Substituto adicionado: ${nome} - ${tarefa}`);
      }

      while (escalaAtual.length < 2 && nomes.length > usados.length) {
        idx = proximoIndice(idx, usados);
        if (idx === -1) break;
        const nome = nomes[idx];
        const tarefa = escalaAtual[0].tarefa === 'mesa' ? 'chão' : 'mesa';
        escalaAtual.push({ nome, tarefa, index: idx });
        historicoTarefa[nome] = tarefa;
        usados.push(nome);
        posicaoUltimaEscala = idx;
        console.log(`Complemento da escala: ${nome} - ${tarefa}`);
      }

      console.log('Escala final:', escalaAtual);
      console.log('Faltantes pendentes:', faltantesPendentes);
      console.log('Histórico de tarefas:', historicoTarefa);
      console.log('Escala antes vs depois:', { antes: escalaAntes, depois: escalaAtual });

      await salvarEscalaNoFirestore();
      atualizarResultadoEFormulario();
    });

    // Funções de edição de nomes
    document.getElementById('btnEditarNomes').addEventListener('click', function() {
      mostrarTela('editar-nomes');
    });

    document.getElementById('btnVoltarEdicao').addEventListener('click', function() {
      mostrarTela('painel');
    });

    function atualizarListaNomesEdicao() {
      const ul = document.getElementById('listaNomesEdicao');
      ul.innerHTML = '';
      nomes.forEach((nome, idx) => {
        const li = document.createElement('li');
        li.textContent = nome;
        const btnRemover = document.createElement('button');
        btnRemover.textContent = 'Remover';
        btnRemover.className = 'removerNomeBtn';
        btnRemover.addEventListener('click', async () => {
          const pessoaNaEscala = escalaAtual.find(p => p.nome === nome);
          nomes.splice(idx, 1);
          escalaAtual = escalaAtual.filter(p => p.nome !== nome);
          faltantesPendentes = faltantesPendentes.filter(f => f.nome !== nome);
          if (pessoaNaEscala && nomes.length > 0) {
            substituirPessoaNaEscala(nome, pessoaNaEscala.tarefa);
          }
          await salvarConfigNoFirestore();
          await salvarEscalaNoFirestore();
          atualizarListaNomesEdicao();
          atualizarResultadoEFormulario();
        });
        li.appendChild(btnRemover);
        ul.appendChild(li);
      });
    }

    document.getElementById('btnAdicionarNome').addEventListener('click', async function() {
      const input = document.getElementById('novoNomeInput');
      const novoNome = input.value.trim();
      if (novoNome.length > 0 && !nomes.some(n => n.toLowerCase() === novoNome.toLowerCase())) {
        nomes.push(novoNome);
        nomes.sort((a, b) => a.localeCompare(b));
        adicionarPessoaNaEscala(novoNome);
        input.value = '';
        await salvarConfigNoFirestore();
        await salvarEscalaNoFirestore();
        atualizarListaNomesEdicao();
        atualizarResultadoEFormulario();
      } else {
        alert('Nome inválido ou já existe!');
      }
    });

    document.getElementById('btnZerarNomes').addEventListener('click', async function() {
      if (confirm('Tem certeza que quer apagar todos os nomes?')) {
        nomes = [];
        try {
          escalaAtual = [];
          faltantesPendentes = [];
          await salvarConfigNoFirestore();
          await salvarEscalaNoFirestore();
          atualizarListaNomesEdicao();
          mostrarTela('painel');
          atualizarResultadoEFormulario();
          alert('Lista de nomes zerada com sucesso!');
        } catch (error) {
          console.error('Erro ao zerar nomes no Firestore:', error);
          alert('Erro ao zerar nomes. Verifique sua conexão.');
        }
      }
    });

    // Funções de gerenciamento de administradores
    document.getElementById('btnLiberarAcesso').addEventListener('click', function() {
      if (isAdmin) {
        mostrarTela('gerenciar-admins');
      }
    });

    document.getElementById('btnVoltarAdmins').addEventListener('click', function() {
      mostrarTela('painel');
    });

    function atualizarListaAdminsEdicao() {
      const ul = document.getElementById('listaAdminsEdicao');
      ul.innerHTML = '';
      admins.forEach((email, idx) => {
        const li = document.createElement('li');
        li.textContent = email;
        const btnRemover = document.createElement('button');
        btnRemover.textContent = 'Remover';
        btnRemover.className = 'removerAdminBtn';
        btnRemover.addEventListener('click', () => {
          if (admins.length <= 1) {
            alert('Não é possível remover o último administrador!');
            return;
          }
          if (usuarioLogado.email === email) {
            alert('Você não pode remover seu próprio email!');
            return;
          }
          admins.splice(idx, 1);
          atualizarListaAdminsEdicao();
          salvarConfigNoFirestore();
        });
        li.appendChild(btnRemover);
        ul.appendChild(li);
      });
    }

    document.getElementById('btnAdicionarAdmin').addEventListener('click', function() {
      const inputEmail = document.getElementById('novoAdminInput');
      const inputSenha = document.getElementById('novaSenhaAdminInput');
      const novoEmail = inputEmail.value.trim();
      const novaSenha = inputSenha.value.trim();
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

      if (!novoEmail || !emailRegex.test(novoEmail)) {
        alert('Digite um email válido!');
        return;
      }
      if (admins.includes(novoEmail)) {
        alert('Este email já está na lista de administradores!');
        return;
      }
      if (novaSenha.length < 6) {
        alert('A senha deve ter pelo menos 6 caracteres!');
        return;
      }

      auth.fetchSignInMethodsForEmail(novoEmail)
        .then((signInMethods) => {
          if (signInMethods.length > 0) {
            admins.push(novoEmail);
            admins.sort((a, b) => a.localeCompare(b));
            adminConfig[novoEmail] = { primeiroLogin: true };
            inputEmail.value = '';
            inputSenha.value = '';
            atualizarListaAdminsEdicao();
            salvarConfigNoFirestore();
          } else {
            auth.createUserWithEmailAndPassword(novoEmail, novaSenha)
              .then((userCredential) => {
                admins.push(novoEmail);
                admins.sort((a, b) => a.localeCompare(b));
                adminConfig[novoEmail] = { primeiroLogin: true };
                inputEmail.value = '';
                inputSenha.value = '';
                atualizarListaAdminsEdicao();
                salvarConfigNoFirestore();
                userCredential.user.sendEmailVerification()
                  .then(() => {
                    console.log('Email de verificação enviado para:', novoEmail);
                  })
                  .catch((error) => {
                    console.error('Erro ao enviar email de verificação:', error);
                  });
              })
              .catch((error) => {
                console.error('Erro ao criar usuário:', error);
                if (error.code === 'auth/email-already-in-use') {
                  alert('Este email já está registrado, mas não como administrador.');
                } else if (error.code === 'auth/invalid-email') {
                  alert('Email inválido.');
                } else {
                  alert('Erro ao criar usuário. Tente novamente.');
                }
              });
          }
        })
        .catch((error) => {
          console.error('Erro ao verificar email:', error);
          alert('Erro ao verificar o email. Verifique se é válido e tente novamente.');
        });
    });

    document.getElementById('btnSalvarAdmins').addEventListener('click', async function() {
      try {
        await salvarConfigNoFirestore();
        alert('Lista de administradores salva com sucesso!');
        mostrarTela('painel');
      } catch (error) {
        console.error('Erro ao salvar administradores no Firestore:', error);
        alert('Erro ao salvar administradores. Verifique sua conexão.');
      }
    });

    // Funções de Minha Conta
    document.getElementById('btnMinhaConta').addEventListener('click', function() {
      if (isAdmin) {
        mostrarTela('minha-conta');
      }
    });

    document.getElementById('btnVoltarMinhaConta').addEventListener('click', function() {
      mostrarTela('painel');
    });

    function atualizarTelaMinhaConta() {
      const mensagemAviso = document.getElementById('mensagemAviso');
      const mensagemErro = document.getElementById('mensagemErroMinhaConta');
      mensagemErro.textContent = '';
      document.getElementById('novaSenhaInput').value = '';
      document.getElementById('confirmarSenhaInput').value = '';
      if (adminConfig[usuarioLogado.email]?.primeiroLogin) {
        mensagemAviso.textContent = 'Bem-vindo! Por favor, defina uma nova senha para sua conta.';
      } else {
        mensagemAviso.textContent = '';
      }
    }

    document.getElementById('btnAlterarSenha').addEventListener('click', function() {
      const novaSenha = document.getElementById('novaSenhaInput').value.trim();
      const confirmarSenha = document.getElementById('confirmarSenhaInput').value.trim();
      const mensagemErro = document.getElementById('mensagemErroMinhaConta');

      if (!novaSenha || !confirmarSenha) {
        mensagemErro.textContent = 'Preencha ambos os campos de senha!';
        return;
      }
      if (novaSenha !== confirmarSenha) {
        mensagemErro.textContent = 'As senhas não coincidem!';
        return;
      }
      if (novaSenha.length < 6) {
        mensagemErro.textContent = 'A senha deve ter pelo menos 6 caracteres!';
        return;
      }

      const user = auth.currentUser;
      if (user) {
        user.updatePassword(novaSenha)
          .then(() => {
            adminConfig[usuarioLogado.email] = { primeiroLogin: false };
            salvarConfigNoFirestore()
              .then(() => {
                alert('Senha alterada com sucesso!');
                mostrarTela('painel');
              })
              .catch((error) => {
                console.error('Erro ao salvar config no Firestore:', error);
                mensagemErro.textContent = 'Erro ao salvar alterações. Tente novamente.';
              });
          })
          .catch((error) => {
            console.error('Erro ao alterar senha:', error);
            if (error.code === 'auth/requires-recent-login') {
              mensagemErro.textContent = 'Por favor, faça login novamente para alterar a senha.';
              auth.signOut().then(() => mostrarTela('login'));
            } else {
              mensagemErro.textContent = 'Erro ao alterar senha. Tente novamente.';
            }
          });
      } else {
        mensagemErro.textContent = 'Usuário não autenticado. Faça login novamente.';
        auth.signOut().then(() => mostrarTela('login'));
      }
    });

    // Carregar escala e configs do Firestore ao iniciar app
    lerEscalaDoFirestore().then(() => {
      if (usuarioLogado) {
        mostrarTela('painel');
      } else {
        mostrarTela('inicio');
      }
    });
  </script>
</body>
</html>
